<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ethereal Chat</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* --- THEME --- */
        :root { --bg: #050505; --surface: #121212; --primary: #00f2ea; --text: #fff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- LOGIN OVERLAY --- */
        #login-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .login-box { width: 80%; max-width: 300px; text-align: center; }
        .login-input { width: 100%; padding: 15px; background: #222; border: 1px solid #333; color: white; border-radius: 10px; margin-bottom: 15px; font-size: 1rem; text-align: center; }
        .btn-glow { width: 100%; padding: 15px; background: var(--primary); border: none; border-radius: 10px; font-weight: bold; cursor: pointer; box-shadow: 0 0 15px rgba(0,242,234,0.2); }

        /* --- MAIN UI --- */
        header { padding: 15px; background: rgba(18,18,18,0.9); border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .brand { font-weight: 600; color: var(--primary); letter-spacing: 1px; }
        .status-badge { font-size: 0.8rem; padding: 5px 10px; background: #222; border-radius: 20px; display: flex; align-items: center; gap: 6px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #555; transition: 0.3s; }
        .dot.online { background: #0f0; box-shadow: 0 0 5px #0f0; }
        .dot.offline { background: red; }

        /* Connection Bar */
        .conn-bar { padding: 10px; background: var(--surface); display: flex; gap: 10px; border-bottom: 1px solid #333; }
        .conn-input { flex: 1; padding: 10px; background: #000; border: 1px solid #333; color: white; border-radius: 8px; }
        .btn-join { background: #333; color: white; border: none; padding: 0 15px; border-radius: 8px; font-weight: 600; }

        /* Chat Area */
        #chat-feed { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 10px 14px; border-radius: 16px; font-size: 0.95rem; word-wrap: break-word; }
        .mine { align-self: flex-end; background: var(--primary); color: #000; border-bottom-right-radius: 2px; }
        .theirs { align-self: flex-start; background: #222; color: #fff; border-bottom-left-radius: 2px; }
        .sys-msg { align-self: center; font-size: 0.75rem; color: #666; background: #111; padding: 4px 10px; border-radius: 10px; }

        /* Typing Animation */
        .typing-indicator { align-self: flex-start; background: #222; padding: 10px 15px; border-radius: 16px; border-bottom-left-radius: 2px; display: none; align-items: center; gap: 4px; }
        .typing-dot { width: 6px; height: 6px; background: #888; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Connection Loader */
        .loader-overlay { position: absolute; top: 60px; left: 0; right: 0; background: rgba(0,0,0,0.8); padding: 10px; text-align: center; display: none; color: var(--primary); font-size: 0.9rem; }

        /* Input Area */
        footer { padding: 10px; background: var(--surface); display: flex; gap: 10px; border-top: 1px solid #333; }
        #msg-input { flex: 1; padding: 12px; background: #000; border: 1px solid #333; color: white; border-radius: 24px; }
        #send-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--primary); border: none; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h1 style="color:white; font-weight:300; letter-spacing:3px; margin-bottom:30px;">ETHEREAL</h1>
            <input type="text" id="username-field" class="login-input" placeholder="Enter your name">
            <button class="btn-glow" onclick="startGame()">ENTER</button>
        </div>
    </div>

    <header>
        <div class="brand">ETHEREAL</div>
        <div class="status-badge" onclick="copyId()">
            <div id="status-dot" class="dot"></div>
            <span id="header-status">Offline</span>
        </div>
    </header>

    <div class="conn-bar">
        <input id="remote-id" class="conn-input" placeholder="Paste Friend's ID">
        <button class="btn-join" onclick="connectManual()">JOIN</button>
    </div>

    <div id="loader" class="loader-overlay">Connecting to secure frequency...</div>

    <div id="chat-feed">
        <div class="sys-msg">Waiting for connection...</div>
        
        <div id="typing-bubble" class="typing-indicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    </div>

    <footer>
        <input id="msg-input" type="text" placeholder="Type a message..." disabled oninput="handleTyping()">
        <button id="send-btn" onclick="sendMessage()" disabled>â†’</button>
    </footer>

    <script>
        // --- CONFIG ---
        let me = { name: "", id: null };
        let peer = null;
        let conn = null;
        let heartbeatInterval = null;
        let typingTimeout = null;

        // --- DOM ---
        const ui = {
            login: document.getElementById('login-screen'),
            userField: document.getElementById('username-field'),
            statusDot: document.getElementById('status-dot'),
            statusText: document.getElementById('header-status'),
            chat: document.getElementById('chat-feed'),
            typing: document.getElementById('typing-bubble'),
            input: document.getElementById('msg-input'),
            send: document.getElementById('send-btn'),
            loader: document.getElementById('loader'),
            remoteInput: document.getElementById('remote-id')
        };

        // 1. LOGIN
        function startGame() {
            const name = ui.userField.value.trim();
            if(!name) return alert("Name is required");
            me.name = name;
            ui.login.style.display = 'none';
            initPeer();
        }

        // 2. PEER INIT
        function initPeer() {
            peer = new Peer();
            
            peer.on('open', (id) => {
                me.id = id;
                setStatus('online', 'You are Online');
                addSystemMsg(`ID generated. Share it!`);
            });

            peer.on('connection', (c) => {
                handleConnection(c);
            });
        }

        // 3. CONNECT LOGIC
        function connectManual() {
            const id = ui.remoteInput.value.trim();
            if(!id) return;
            
            ui.loader.style.display = 'block'; // Show Animation
            const c = peer.connect(id);
            handleConnection(c);
        }

        function handleConnection(connection) {
            if(conn) conn.close();
            conn = connection;

            conn.on('open', () => {
                ui.loader.style.display = 'none'; // Hide Animation
                ui.input.disabled = false;
                ui.send.disabled = false;
                ui.remoteInput.value = "";
                
                // Send Identity
                conn.send({ type: 'join', name: me.name });
                startHeartbeat(); // Start checking if alive
            });

            conn.on('data', (data) => {
                handleData(data);
            });

            conn.on('close', () => {
                stopHeartbeat();
                setStatus('offline', 'Disconnected');
                ui.input.disabled = true;
                ui.send.disabled = true;
                addSystemMsg("Peer disconnected.");
                conn = null;
            });

            // If user closes tab, send a final 'bye' signal
            window.onbeforeunload = () => {
                if(conn) conn.send({ type: 'leave' });
            }
        }

        // 4. DATA HANDLER
        function handleData(data) {
            switch(data.type) {
                case 'join':
                    addSystemMsg(`${data.name} joined the chat.`);
                    setStatus('online', `Connected: ${data.name}`);
                    break;
                case 'chat':
                    ui.typing.style.display = 'none'; // Hide typing if msg comes
                    addMessage(data.text, 'theirs');
                    break;
                case 'typing':
                    if(data.status) {
                        ui.typing.style.display = 'flex';
                        ui.chat.appendChild(ui.typing); // Move to bottom
                        ui.chat.scrollTop = ui.chat.scrollHeight;
                    } else {
                        ui.typing.style.display = 'none';
                    }
                    break;
                case 'leave':
                    // Immediate offline detection
                    setStatus('offline', 'Peer Left');
                    addSystemMsg("User left the chat.");
                    conn.close();
                    break;
                case 'ping':
                    // Received heartbeat, just ignore, it keeps connection alive
                    break;
            }
        }

        // 5. MESSAGING & TYPING
        function sendMessage() {
            const text = ui.input.value.trim();
            if(!text || !conn) return;
            
            conn.send({ type: 'chat', text: text });
            addMessage(text, 'mine');
            ui.input.value = "";
            
            // Stop typing indicator immediately
            conn.send({ type: 'typing', status: false });
        }

        function handleTyping() {
            if(!conn) return;
            
            // Send "I am typing"
            conn.send({ type: 'typing', status: true });

            // Clear old timeout
            if(typingTimeout) clearTimeout(typingTimeout);

            // Stop typing after 1 second of no keys
            typingTimeout = setTimeout(() => {
                conn.send({ type: 'typing', status: false });
            }, 1000);
        }

        // 6. HEARTBEAT (Online Status)
        function startHeartbeat() {
            // Send a silent 'ping' every 2 seconds to prove we are online
            heartbeatInterval = setInterval(() => {
                if(conn && conn.open) {
                    conn.send({ type: 'ping' });
                }
            }, 2000);
        }

        function stopHeartbeat() {
            if(heartbeatInterval) clearInterval(heartbeatInterval);
        }

        // 7. UI HELPERS
        function setStatus(state, text) {
            ui.statusDot.className = `dot ${state}`;
            ui.statusText.innerText = text;
        }

        function addMessage(text, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerText = text;
            // Insert before typing bubble
            ui.chat.insertBefore(div, ui.typing);
            ui.chat.scrollTop = ui.chat.scrollHeight;
        }

        function addSystemMsg(text) {
            const div = document.createElement('div');
            div.className = 'sys-msg';
            div.innerText = text;
            ui.chat.insertBefore(div, ui.typing);
            ui.chat.scrollTop = ui.chat.scrollHeight;
        }
        
        function copyId() {
            if(me.id) {
                navigator.clipboard.writeText(me.id);
                alert("ID Copied: " + me.id);
            }
        }
    </script>
</body>
</html>