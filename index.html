<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ethereal Chat - Full Feature Mobile</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg-color: #0f0f0f; --chat-bg: #1a1a1a; --primary: #3b82f6; --text: #e0e0e0; --incoming: #262626; --outgoing: var(--primary); --danger: #ef4444; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-color); color: var(--text); height: 100vh; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* SETUP SCREEN */
        #setup-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .setup-box { background: #1e1e1e; padding: 30px; border-radius: 20px; text-align: center; width: 85%; max-width: 400px; border: 1px solid #333; }
        .setup-box input { padding: 12px; border-radius: 10px; border: 1px solid #444; background: #333; color: white; width: 100%; box-sizing: border-box; text-align: center; font-size: 16px; margin-bottom: 10px; }
        .avatar-upload { width: 80px; height: 80px; border-radius: 50%; background: #333; border: 2px dashed #555; display: flex; align-items: center; justify-content: center; cursor: pointer; margin: 0 auto 15px auto; overflow: hidden; }
        .avatar-upload img { width: 100%; height: 100%; object-fit: cover; display: none; }

        /* HEADER */
        .header { padding: 10px 15px; background: #1a1a1a; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #333; height: 50px; flex-shrink: 0; }
        .app-title { font-weight: 800; font-size: 1.1rem; color: white; }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        .icon-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; position: relative; padding: 5px; }
        .active-ghost { text-shadow: 0 0 10px var(--danger); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* CONNECTION & STATUS */
        .connection-panel { background: #161616; padding: 15px; display: flex; gap: 10px; border-bottom: 1px solid #222; }
        .connection-panel.collapsed { display: none; }
        #status-bar { padding: 8px; background: #059669; color: white; text-align: center; font-size: 0.8rem; display: none; font-weight: bold; }
        .id-display { font-family: monospace; background: #333; padding: 5px 8px; border-radius: 5px; color: #fff; border: 1px solid #444; font-size: 0.8rem; }

        /* CHAT WINDOW */
        #chat-window { flex: 1; padding: 15px 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .msg-row { display: flex; gap: 8px; max-width: 85%; align-items: flex-end; position: relative; }
        .msg-row.outgoing { align-self: flex-end; flex-direction: row-reverse; }
        .chat-avatar { width: 30px; height: 30px; border-radius: 50%; background: #333; object-fit: cover; flex-shrink: 0; }
        
        .message { padding: 8px 12px; border-radius: 16px; font-size: 15px; line-height: 1.4; background: var(--incoming); color: var(--text); word-wrap: break-word; min-width: 40px; }
        .msg-row.outgoing .message { background: var(--outgoing); color: white; border-bottom-right-radius: 4px; }
        .msg-row.incoming .message { background: var(--incoming); border-bottom-left-radius: 4px; }

        /* FEATURES: GHOST, REPLY, QUOTE */
        .ghost-msg { border: 1px solid var(--danger); }
        .ghost-timer { font-size: 0.7em; color: var(--danger); display: block; font-weight: bold; margin-top: 2px; }
        
        .reply-btn { opacity: 0.5; font-size: 0.8rem; cursor: pointer; padding: 0 5px; }
        .quote-block { background: rgba(0,0,0,0.2); border-left: 3px solid rgba(255,255,255,0.5); padding: 4px 8px; font-size: 0.8em; margin-bottom: 4px; border-radius: 4px; opacity: 0.8; }
        
        /* INPUT AREA */
        .input-wrapper { background: #1a1a1a; padding-bottom: env(safe-area-inset-bottom); }
        #reply-preview-bar { background: #252525; padding: 8px 15px; display: none; align-items: center; justify-content: space-between; border-top: 1px solid #333; font-size: 0.85em; color: #ccc; border-left: 4px solid var(--primary); }
        
        .input-area { padding: 10px; display: flex; gap: 8px; align-items: center; position: relative; }
        input[type="text"] { padding: 10px 15px; border-radius: 25px; border: none; background: #2d2d2d; color: white; flex: 1; font-size: 16px; outline: none; }
        .btn-primary { padding: 10px 15px; border-radius: 25px; border: none; background: var(--primary); color: white; font-weight: bold; }
        .tool-btn { background: none; border: none; font-size: 1.3rem; padding: 0 5px; cursor: pointer; }

        /* MENUS */
        #game-menu, #emoji-picker { position: absolute; bottom: 70px; background: #262626; border: 1px solid #444; border-radius: 15px; padding: 10px; display: none; box-shadow: 0 -10px 30px rgba(0,0,0,0.6); z-index: 100; }
        #game-menu { left: 10px; width: 200px; flex-direction: column; gap: 5px; }
        #emoji-picker { left: 0; right: 0; margin: auto; width: 90%; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 10px; }
        
        .menu-item { padding: 10px; background: #333; border-radius: 8px; cursor: pointer; font-size: 0.9rem; }
        .emoji-item { font-size: 1.5rem; text-align: center; cursor: pointer; }

        /* GAMES OVERLAY */
        #game-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .close-game { position: absolute; top: 20px; right: 20px; background: #ef4444; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; }
        .ttt-board { display: grid; grid-template-columns: repeat(3, 70px); gap: 5px; margin-top: 20px; }
        .cell { width: 70px; height: 70px; background: #333; display: flex; align-items: center; justify-content: center; font-size: 2em; cursor: pointer; }
        .rps-board { display: flex; gap: 15px; margin-top: 20px; }
        .rps-btn { width: 70px; height: 70px; border-radius: 50%; border: 3px solid #555; background: #222; font-size: 28px; cursor: pointer; }
        #wb-container { width: 100%; height: 60%; background: white; border-radius: 10px; overflow: hidden; position: relative; touch-action: none; }
        canvas { display: block; width: 100%; height: 100%; }

    </style>
</head>
<body>

    <div id="setup-screen">
        <div class="setup-box">
            <h2>Ethereal Chat V5</h2>
            <label class="avatar-upload">
                <img id="avatar-preview" src="">
                <span id="avatar-placeholder">üì∑</span>
                <input type="file" id="avatar-input" hidden accept="image/*">
            </label>
            <input type="text" id="username-input" placeholder="Your Name">
            <button class="btn-primary" style="width:100%" onclick="startApp()">Enter Chat</button>
        </div>
    </div>

    <div id="main-app" style="display:none; height:100%; flex-direction:column;">
        <div class="header">
            <div class="app-title">Ethereal</div>
            <div class="header-actions">
                <button class="icon-btn" id="ghost-btn" onclick="toggleGhostMode()" title="Hidden Symbol / Ghost Mode">üëª</button>
                <span id="my-id" class="id-display" onclick="copyId()">ID...</span>
                <button class="icon-btn" onclick="clearChat()">üóëÔ∏è</button>
            </div>
        </div>

        <div class="connection-panel" id="conn-panel">
            <input type="text" id="friend-id-input" placeholder="Friend ID" style="text-transform:uppercase;">
            <button class="btn-primary" id="connect-btn">Connect</button>
        </div>

        <div id="status-bar">Connected</div>

        <div id="chat-window"></div>

        <div class="input-wrapper">
            <div id="reply-preview-bar">
                <span id="reply-text-preview">Replying...</span>
                <button onclick="cancelReply()" style="background:none; border:none; color:#ef4444;">‚úï</button>
            </div>

            <div class="input-area">
                <div id="game-menu">
                    <div class="menu-item" onclick="initiateGame('tictactoe')">‚≠ï‚ùå Tic Tac Toe</div>
                    <div class="menu-item" onclick="initiateGame('rps')">‚úÇÔ∏è Rock Paper Scissors</div>
                    <div class="menu-item" onclick="initiateGame('whiteboard')">‚úèÔ∏è Draw Together</div>
                </div>
                
                <div id="emoji-picker">
                    <div class="emoji-item" onclick="insertEmoji('üòÄ')">üòÄ</div>
                    <div class="emoji-item" onclick="insertEmoji('üòÇ')">üòÇ</div>
                    <div class="emoji-item" onclick="insertEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</div>
                    <div class="emoji-item" onclick="insertEmoji('ü•∫')">ü•∫</div>
                    <div class="emoji-item" onclick="insertEmoji('üî•')">üî•</div>
                    <div class="emoji-item" onclick="insertEmoji('üëç')">üëç</div>
                    <div class="emoji-item" onclick="insertEmoji('üíÄ')">üíÄ</div>
                    <div class="emoji-item" onclick="insertEmoji('üéâ')">üéâ</div>
                </div>

                <button class="tool-btn" onclick="toggleMenu('game-menu')">üéÆ</button>
                <button class="tool-btn" onclick="toggleMenu('emoji-picker')">üòÄ</button>
                <button class="tool-btn" onclick="document.getElementById('file-input').click()">üìé</button>
                
                <input type="file" id="file-input" hidden>
                <input type="text" id="msg-input" placeholder="Message..." autocomplete="off">
                <button id="send-btn" class="btn-primary">‚û§</button>
            </div>
        </div>
    </div>

    <div id="game-overlay">
        <button class="close-game" onclick="closeGame()">Exit</button>
        <h2 id="game-title" style="color:white; margin-top:40px;">Game</h2>
        <div id="game-status" style="color:#aaa; margin-bottom:10px;">Waiting...</div>
        
        <div id="ttt-container" style="display:none;"><div class="ttt-board" id="ttt-board"></div></div>
        
        <div id="rps-container" style="display:none;"><div class="rps-board">
            <button class="rps-btn" onclick="playRPS('rock')">ü™®</button>
            <button class="rps-btn" onclick="playRPS('paper')">üìÉ</button>
            <button class="rps-btn" onclick="playRPS('scissors')">‚úÇÔ∏è</button>
        </div></div>

        <div id="wb-container" style="display:none;"><canvas id="wb-canvas"></canvas></div>
        <div id="wb-tools" style="display:none; margin-top:10px;">
            <button onclick="clearWhiteboard()" class="btn-primary" style="background:red;">Clear Board</button>
        </div>
    </div>

    <script>
        let peer, conn;
        let myName = "User", friendName = "Friend";
        let myAvatar = null, friendAvatar = null;
        let isGhostMode = false;
        let replyingTo = null;
        let myColor = "#3b82f6";

        // CONFIG WITH STUN (Connection Fix)
        const peerConfig = {
            config: { iceServers: [ { urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' } ] }
        };

        // --- AVATAR ---
        document.getElementById('avatar-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = 100; canvas.height = 100;
                        ctx.drawImage(img, 0, 0, 100, 100);
                        myAvatar = canvas.toDataURL('image/jpeg', 0.8);
                        document.getElementById('avatar-preview').src = myAvatar;
                        document.getElementById('avatar-preview').style.display = 'block';
                        document.getElementById('avatar-placeholder').style.display = 'none';
                    };
                    img.src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        });

        // --- CORE ---
        function generateShortId() { return Math.random().toString(36).substr(2, 6).toUpperCase(); }

        function startApp() {
            myName = document.getElementById('username-input').value.trim() || "User";
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            initializePeer();
        }

        function initializePeer() {
            const shortId = generateShortId();
            document.getElementById('my-id').innerText = "Connecting...";
            peer = new Peer(shortId, peerConfig);

            peer.on('open', (id) => { document.getElementById('my-id').innerText = id; });
            peer.on('connection', (c) => { handleConnection(c); });
            peer.on('error', (err) => { 
                if(err.type==='unavailable-id') initializePeer();
                else alert("Connection Error: " + err.type); 
            });
            peer.on('disconnected', () => peer.reconnect());
        }

        document.getElementById('connect-btn').addEventListener('click', () => {
            const fid = document.getElementById('friend-id-input').value.trim().toUpperCase();
            if(fid) handleConnection(peer.connect(fid));
        });

        function handleConnection(connection) {
            conn = connection;
            conn.on('open', () => {
                document.getElementById('conn-panel').classList.add('collapsed');
                document.getElementById('status-bar').style.display = 'block';
                conn.send({ type: 'info', name: myName, avatar: myAvatar });
            });

            conn.on('data', (data) => {
                if(data.type === 'info') {
                    friendName = data.name; friendAvatar = data.avatar;
                    document.getElementById('status-bar').innerText = `Connected with ${friendName}`;
                } else if(data.type === 'text') {
                    addMessage(friendName, data.content, 'incoming', data.id, data.replyContext, data.isGhost);
                } else if(data.type === 'file') {
                    addFile(friendName, data.content, data.fileName, 'incoming', data.isGhost);
                } else if(data.type === 'game-invite') {
                    startGameUI(data.game);
                } else if(data.type === 'game-move') {
                    handleGameMove(data);
                } else if(data.type === 'draw') {
                    drawOnCanvas(data.x0, data.y0, data.x1, data.y1, data.color, false);
                } else if(data.type === 'clear-wb') {
                    clearCanvasLocal();
                }
            });
            conn.on('close', () => { alert("Disconnected"); location.reload(); });
        }

        // --- FEATURES ---
        function toggleGhostMode() {
            isGhostMode = !isGhostMode;
            const btn = document.getElementById('ghost-btn');
            if(isGhostMode) btn.classList.add('active-ghost'); else btn.classList.remove('active-ghost');
        }

        function toggleMenu(id) {
            const el = document.getElementById(id);
            el.style.display = (el.style.display === 'flex' || el.style.display === 'grid') ? 'none' : (id==='emoji-picker'?'grid':'flex');
        }
        
        function insertEmoji(e) { 
            document.getElementById('msg-input').value += e; 
            document.getElementById('msg-input').focus();
        }

        function setReply(id, text, sender) {
            replyingTo = { id, text, sender };
            document.getElementById('reply-preview-bar').style.display = 'flex';
            document.getElementById('reply-text-preview').innerText = `Replying to ${sender}`;
            document.getElementById('msg-input').focus();
        }
        function cancelReply() { replyingTo = null; document.getElementById('reply-preview-bar').style.display = 'none'; }
        
        function clearChat() { if(confirm("Clear?")) document.getElementById('chat-window').innerHTML=''; }
        function copyId() { navigator.clipboard.writeText(document.getElementById('my-id').innerText); alert("ID Copied"); }

        // --- MESSAGING ---
        document.getElementById('send-btn').addEventListener('click', sendMessage);
        
        function sendMessage() {
            const text = document.getElementById('msg-input').value;
            if(!text) return;
            const msgId = Date.now();

            if(conn && conn.open) {
                conn.send({ type: 'text', content: text, id: msgId, isGhost: isGhostMode, replyContext: replyingTo });
                addMessage('You', text, 'outgoing', msgId, replyingTo, isGhostMode);
                document.getElementById('msg-input').value = '';
                document.getElementById('emoji-picker').style.display='none';
                document.getElementById('game-menu').style.display='none';
                cancelReply();
            } else alert("Not connected");
        }

        function addMessage(sender, text, type, id, replyContext, ghost) {
            const row = document.createElement('div');
            row.className = `msg-row ${type}`;
            
            const img = document.createElement('img');
            img.className = 'chat-avatar';
            img.src = (type==='incoming' ? friendAvatar : myAvatar) || 'https://via.placeholder.com/30';
            
            // Reply Button
            const rBtn = document.createElement('span');
            rBtn.className = 'reply-btn'; rBtn.innerText = '‚Ü©Ô∏è';
            rBtn.onclick = () => setReply(id, text, sender);

            const bubble = document.createElement('div');
            bubble.className = 'message' + (ghost ? ' ghost-msg' : '');
            
            let content = '';
            if(replyContext) content += `<div class="quote-block"><b>${replyContext.sender}</b>: ${replyContext.text.substring(0,20)}...</div>`;
            content += text;
            if(ghost) content += `<span class="ghost-timer">üí£ 10s</span>`;
            
            bubble.innerHTML = content;

            if(type === 'incoming') { row.appendChild(img); row.appendChild(bubble); row.appendChild(rBtn); }
            else { row.appendChild(rBtn); row.appendChild(bubble); row.appendChild(img); }

            document.getElementById('chat-window').appendChild(row);
            document.getElementById('chat-window').scrollTop = 999999;

            if(ghost) setTimeout(() => { row.style.opacity='0'; setTimeout(()=>row.remove(),1000); }, 10000);
        }

        // --- FILE ---
        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const b64 = ev.target.result;
                addFile('You', b64, file.name, 'outgoing', isGhostMode);
                if(conn) conn.send({ type:'file', content:b64, fileName:file.name, isGhost:isGhostMode });
            };
            reader.readAsDataURL(file);
        });

        function addFile(sender, src, name, type, ghost) {
            // Simplified reuse of addMessage structure for file
            const row = document.createElement('div'); row.className = `msg-row ${type}`;
            const bubble = document.createElement('div'); bubble.className = 'message' + (ghost ? ' ghost-msg' : '');
            
            let inner = src.startsWith('data:image') ? `<img src="${src}" style="max-width:200px; border-radius:10px;" onclick="download('${src}','${name}')">` : `<u onclick="download('${src}','${name}')">üìÑ ${name}</u>`;
            if(ghost) inner += `<span class="ghost-timer">üí£ 10s</span>`;
            bubble.innerHTML = inner;
            
            row.appendChild(bubble);
            document.getElementById('chat-window').appendChild(row);
            if(ghost) setTimeout(() => row.remove(), 10000);
        }
        function download(u,n){ const a=document.createElement('a'); a.href=u; a.download=n; document.body.appendChild(a); a.click(); document.body.removeChild(a); }

        // --- GAMES & WHITEBOARD ---
        let tttState = Array(9).fill(null), myTurn=false, mySymbol='X', myRPS=null, oppRPS=null;
        
        function initiateGame(g) { 
            if(conn && conn.open){ myTurn=true; mySymbol='X'; conn.send({type:'game-invite',game:g}); startGameUI(g); }
            else alert("Connect first");
            document.getElementById('game-menu').style.display='none';
        }

        function startGameUI(g) {
            document.getElementById('game-overlay').style.display='flex';
            ['ttt-container','rps-container','wb-container','wb-tools'].forEach(id=>document.getElementById(id).style.display='none');
            
            if(g==='tictactoe'){ 
                document.getElementById('ttt-container').style.display='block'; 
                tttState.fill(null); renderTTT(); document.getElementById('game-status').innerText=myTurn?"Your Turn":"Opponent's Turn";
            } else if(g==='rps'){ 
                document.getElementById('rps-container').style.display='flex'; document.getElementById('game-status').innerText="Choose...";
            } else if(g==='whiteboard'){
                document.getElementById('wb-container').style.display='block';
                document.getElementById('wb-tools').style.display='block';
                initWhiteboard();
            }
        }
        function closeGame(){ document.getElementById('game-overlay').style.display='none'; }

        function handleGameMove(d) {
            if(d.game==='tictactoe'){ tttState[d.index]=d.symbol; renderTTT(); if(!checkWinner(tttState)){myTurn=true;document.getElementById('game-status').innerText="Your Turn";} }
            else if(d.game==='rps'){ oppRPS=d.move; if(myRPS) resolveRPS(); else document.getElementById('game-status').innerText="Opponent chose."; }
        }

        // TTT
        function renderTTT(){ 
            const b=document.getElementById('ttt-board'); b.innerHTML='';
            tttState.forEach((v,i)=>{
                const c=document.createElement('div'); c.className='cell'; c.innerText=v||'';
                c.style.color = v==='X'?'#ef4444':'#3b82f6';
                c.onclick=()=>{
                    if(!myTurn||tttState[i]||!conn)return;
                    tttState[i]=mySymbol; renderTTT(); myTurn=false; 
                    conn.send({type:'game-move',game:'tictactoe',index:i,symbol:mySymbol});
                    checkWinner(tttState); document.getElementById('game-status').innerText="Waiting...";
                };
                b.appendChild(c);
            });
        }
        function checkWinner(b){
            const w=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for(let c of w){ if(b[c[0]]&&b[c[0]]===b[c[1]]&&b[c[0]]===b[c[2]]){ alert((b[c[0]]===mySymbol?"You":"Friend")+" Win!"); return true; }}
            if(!b.includes(null)){ alert("Draw"); return true; } return false;
        }

        // RPS
        function playRPS(m){ 
            if(myRPS)return; myRPS=m; document.getElementById('game-status').innerText="Waiting...";
            conn.send({type:'game-move',game:'rps',move:m}); if(oppRPS) resolveRPS();
        }
        function resolveRPS(){
            let r=myRPS===oppRPS?"Draw":(myRPS==='rock'&&oppRPS==='scissors'||myRPS==='paper'&&oppRPS==='rock'||myRPS==='scissors'&&oppRPS==='paper')?"You Win":"You Lose";
            document.getElementById('game-status').innerText=r; 
            setTimeout(()=>{myRPS=null;oppRPS=null;document.getElementById('game-status').innerText="Play Again?";},2000);
        }

        // WHITEBOARD
        let canvas, ctx, drawing=false, lastX=0, lastY=0;
        function initWhiteboard(){ 
            canvas=document.getElementById('wb-canvas'); ctx=canvas.getContext('2d');
            setTimeout(()=>{ 
                const r=canvas.parentElement.getBoundingClientRect(); 
                canvas.width=r.width; canvas.height=r.height; 
            },100);
            
            canvas.addEventListener('mousedown',e=>startDraw(e)); canvas.addEventListener('mousemove',e=>draw(e)); canvas.addEventListener('mouseup',()=>drawing=false);
            canvas.addEventListener('touchstart',e=>{e.preventDefault();startDraw(e.touches[0])}, {passive:false});
            canvas.addEventListener('touchmove',e=>{e.preventDefault();draw(e.touches[0])}, {passive:false});
            canvas.addEventListener('touchend',()=>drawing=false);
        }
        function startDraw(e){ drawing=true; const r=canvas.getBoundingClientRect(); lastX=e.clientX-r.left; lastY=e.clientY-r.top; }
        function draw(e){ 
            if(!drawing)return; const r=canvas.getBoundingClientRect(); const x=e.clientX-r.left, y=e.clientY-r.top;
            drawOnCanvas(lastX,lastY,x,y,myColor,true); lastX=x; lastY=y; 
        }
        function drawOnCanvas(x0,y0,x1,y1,c,emit){ 
            ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x1,y1); ctx.strokeStyle=c; ctx.lineWidth=3; ctx.stroke();
            if(emit&&conn) conn.send({type:'draw',x0,y0,x1,y1,color:c});
        }
        function clearWhiteboard(){ ctx.clearRect(0,0,canvas.width,canvas.height); if(conn)conn.send({type:'clear-wb'}); }
        function clearCanvasLocal(){ if(ctx) ctx.clearRect(0,0,canvas.width,canvas.height); }
    </script>
</body>
</html>
