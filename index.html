<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethereal Chat - Ultimate</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-color: #0f0f0f;
            --chat-bg: #1a1a1a;
            --primary: #3b82f6; /* Default Blue */
            --text: #e0e0e0;
            --incoming: #262626;
            --outgoing: var(--primary);
            --danger: #ef4444;
        }

        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-color); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- SETUP SCREEN --- */
        #setup-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .setup-box { background: #1e1e1e; padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #333; }
        .setup-box input { padding: 10px; border-radius: 10px; border: 1px solid #444; background: #333; color: white; width: 200px; text-align: center; margin-bottom: 15px; font-size: 1rem; }

        /* --- HEADER --- */
        .header {
            padding: 15px 20px; background: #1a1a1a; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #333;
        }
        .app-title {
            font-size: 1.5rem; font-weight: 800;
            background: linear-gradient(90deg, var(--primary), #ffffff);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .header-actions { display: flex; align-items: center; gap: 15px; }
        .icon-btn { background: none; border: none; cursor: pointer; color: #888; font-size: 1.1rem; transition: 0.2s; position: relative; }
        .icon-btn:hover { color: white; }
        
        /* Color Picker Hidden Input */
        #color-picker-input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        /* --- CONNECTION PANEL --- */
        .connection-panel {
            background: #161616; padding: 15px; display: flex; gap: 10px; align-items: center; border-bottom: 1px solid #222; transition: all 0.5s ease; max-height: 100px;
        }
        .connection-panel.collapsed { max-height: 0; padding: 0 15px; opacity: 0; pointer-events: none; border: none; }
        .id-display { font-family: monospace; background: #333; padding: 5px 10px; border-radius: 5px; letter-spacing: 2px; color: #fff; cursor: pointer; border: 1px solid #444; font-size: 0.9rem; }
        
        /* --- STATUS & TYPING --- */
        .status-bar { padding: 5px 20px; background: #059669; font-size: 0.8em; display: none; justify-content: space-between; align-items: center; color: white; font-weight: bold; }
        .typing-indicator { font-size: 0.75rem; color: #888; padding: 0 20px; margin-top: 5px; font-style: italic; height: 15px; opacity: 0; transition: opacity 0.3s; }

        /* --- CHAT AREA --- */
        #chat-window { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }

        .message {
            max-width: 75%; padding: 10px 15px; border-radius: 18px; word-wrap: break-word; font-size: 15px; position: relative; line-height: 1.4; user-select: none;
        }
        .incoming { align-self: flex-start; background: var(--incoming); border-bottom-left-radius: 4px; }
        .outgoing { align-self: flex-end; background: var(--outgoing); border-bottom-right-radius: 4px; color: white; }

        .timestamp { font-size: 0.65em; opacity: 0.7; text-align: right; margin-top: 4px; display: block; }
        .sender-name { font-size: 0.75em; color: #aaa; margin-bottom: 2px; display: block; }
        
        /* Reaction Heart */
        .reaction { position: absolute; bottom: -10px; right: -5px; background: #2d2d2d; border-radius: 50%; padding: 2px 5px; font-size: 0.8rem; border: 1px solid #444; display: none; }
        .message.liked .reaction { display: block; }

        /* --- MEDIA STYLING --- */
        .msg-image { width: 100%; max-width: 250px; height: 150px; object-fit: cover; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); margin-top: 5px; display: block; cursor: pointer; transition: 0.2s; }
        .msg-image:hover { opacity: 0.8; }
        
        .file-attachment {
            background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; margin-top: 5px; display: flex; align-items: center; gap: 10px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1);
        }
        .file-icon { font-size: 1.5rem; }
        .file-name { font-size: 0.9rem; text-decoration: underline; word-break: break-all; }

        audio { max-width: 200px; height: 35px; margin-top: 5px; border-radius: 20px; }
        audio::-webkit-media-controls-panel { background-color: #f0f0f0; }

        /* --- INPUT --- */
        .input-area { padding: 15px 20px; background: #1a1a1a; display: flex; gap: 10px; position: relative; align-items: center; }
        input[type="text"] { padding: 12px; border-radius: 25px; border: none; outline: none; background: #2d2d2d; color: white; flex: 1; }
        
        .btn-primary { padding: 10px 20px; border-radius: 25px; border: none; background: var(--primary); color: white; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-primary:hover { opacity: 0.9; }

        .tool-btn { background: none; border: none; font-size: 1.3rem; cursor: pointer; color: #888; padding: 0 5px; transition: 0.2s; }
        .tool-btn:hover { color: white; transform: scale(1.1); }
        .recording { color: var(--danger) !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- MENUS --- */
        #game-menu {
            position: absolute; bottom: 80px; left: 20px; background: #262626; border: 1px solid #444; border-radius: 15px; padding: 10px; display: none; flex-direction: column; gap: 5px; width: 200px; box-shadow: 0 -10px 30px rgba(0,0,0,0.6); z-index: 10;
        }
        #emoji-picker {
            position: absolute; bottom: 80px; left: 60px; background: #262626; border: 1px solid #444; border-radius: 15px; padding: 10px; display: none; grid-template-columns: repeat(5, 1fr); gap: 10px; width: 220px; box-shadow: 0 -10px 30px rgba(0,0,0,0.6); z-index: 10;
        }
        .emoji-item { font-size: 1.5rem; cursor: pointer; text-align: center; }
        .emoji-item:hover { transform: scale(1.2); }
        .game-option { padding: 10px; border-radius: 10px; background: #333; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        .game-option:hover { background: var(--primary); }

        /* --- GAME & WHITEBOARD OVERLAY --- */
        #game-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000;
        }
        .close-game { position: absolute; top: 20px; right: 20px; background: #ef4444; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; }
        
        /* Games */
        .ttt-board { display: grid; grid-template-columns: repeat(3, 80px); gap: 5px; margin-top: 20px; }
        .cell { width: 80px; height: 80px; background: #333; display: flex; align-items: center; justify-content: center; font-size: 2.5em; cursor: pointer; border-radius: 5px;}
        .rps-board { display: flex; gap: 20px; margin-top: 20px; }
        .rps-btn { width: 90px; height: 90px; border-radius: 50%; border: 3px solid #555; background: #222; font-size: 30px; cursor: pointer; transition: 0.2s; }
        .rps-btn:hover { border-color: var(--primary); transform: scale(1.1); }

        /* Whiteboard */
        #wb-container { width: 90%; height: 70%; background: white; border-radius: 10px; overflow: hidden; position: relative; cursor: crosshair; }
        canvas { display: block; width: 100%; height: 100%; }
        .wb-tools { display: flex; gap: 10px; margin-top: 10px; }

    </style>
</head>
<body>

    <div id="setup-screen">
        <div class="setup-box">
            <h2 class="app-title" style="font-size: 2rem; margin-bottom: 20px;">Ethereal Chat</h2>
            <input type="text" id="username-input" placeholder="Enter Your Name">
            <br>
            <button class="btn-primary" onclick="startApp()">Start Chatting</button>
        </div>
    </div>

    <div id="main-app" style="display:none; height:100%; flex-direction:column;">
        
        <div class="header">
            <div class="app-title">Ethereal Chat</div>
            <div class="header-actions">
                <button class="icon-btn" title="Change Theme Color">
                    üé®
                    <input type="color" id="color-picker-input" onchange="changeTheme(this.value)">
                </button>
                <div style="display:flex; align-items:center; gap:5px;">
                    <span style="font-size:0.8rem; color:#888;">ID:</span>
                    <span id="my-id" class="id-display" onclick="copyId()" title="Click to Copy">...</span>
                </div>
                <button class="icon-btn" onclick="clearChat()" title="Clear Chat History">üóëÔ∏è</button>
            </div>
        </div>

        <div class="connection-panel" id="conn-panel">
            <input type="text" id="friend-id-input" placeholder="Enter Friend's Short ID">
            <button class="btn-primary" id="connect-btn">Connect</button>
        </div>

        <div id="status-bar" class="status-bar">
            <span id="connection-status-text">Connected</span>
            <button onclick="location.reload()" style="background:none; border:none; color:white; cursor:pointer; font-weight:bold;">‚úï</button>
        </div>

        <div id="chat-window"></div>

        <div id="typing-indicator" class="typing-indicator"></div>

        <div class="input-area">
            
            <div id="game-menu">
                <div class="game-option" onclick="initiateGame('tictactoe')">‚≠ï‚ùå Tic Tac Toe</div>
                <div class="game-option" onclick="initiateGame('rps')">‚úÇÔ∏è Rock Paper Scissors</div>
                <div class="game-option" onclick="initiateGame('whiteboard')">‚úèÔ∏è Draw Together</div>
            </div>

            <div id="emoji-picker">
                <div class="emoji-item" onclick="insertEmoji('üòÄ')">üòÄ</div>
                <div class="emoji-item" onclick="insertEmoji('üòÇ')">üòÇ</div>
                <div class="emoji-item" onclick="insertEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</div>
                <div class="emoji-item" onclick="insertEmoji('ü•∫')">ü•∫</div>
                <div class="emoji-item" onclick="insertEmoji('üòé')">üòé</div>
                <div class="emoji-item" onclick="insertEmoji('üëç')">üëç</div>
                <div class="emoji-item" onclick="insertEmoji('üéâ')">üéâ</div>
                <div class="emoji-item" onclick="insertEmoji('üî•')">üî•</div>
                <div class="emoji-item" onclick="insertEmoji('üíÄ')">üíÄ</div>
                <div class="emoji-item" onclick="insertEmoji('üëª')">üëª</div>
            </div>
            
            <button class="tool-btn" onclick="toggleEmoji()">üòÄ</button>
            <button class="tool-btn" onclick="document.getElementById('file-input').click()">üìé</button>
            <button class="tool-btn" id="mic-btn">üé§</button>

            <input type="file" id="file-input" hidden>
            <input type="text" id="msg-input" placeholder="Type a message... (@ for menu)">
            <button id="send-btn" class="btn-primary">‚û§</button>
        </div>
    </div>

    <div id="game-overlay">
        <button class="close-game" onclick="closeGame()">Exit</button>
        <h2 id="game-title" style="color:white;">Game</h2>
        <div id="game-status" style="color:#aaa; margin-bottom:10px;">Waiting...</div>
        
        <div id="ttt-container" style="display:none;">
            <div class="ttt-board" id="ttt-board"></div>
        </div>

        <div id="rps-container" style="display:none;">
            <div class="rps-board">
                <button class="rps-btn" onclick="playRPS('rock')">ü™®</button>
                <button class="rps-btn" onclick="playRPS('paper')">üìÉ</button>
                <button class="rps-btn" onclick="playRPS('scissors')">‚úÇÔ∏è</button>
            </div>
        </div>

        <div id="wb-container" style="display:none;">
            <canvas id="wb-canvas"></canvas>
        </div>
        <div id="wb-tools" class="wb-tools" style="display:none;">
            <button onclick="clearWhiteboard()" style="padding:5px 10px; background:red; color:white; border:none; border-radius:5px; cursor:pointer;">Clear Board</button>
        </div>
    </div>

    <script>
        let peer, conn;
        let myName = "User", friendName = "Friend";
        let typingTimeout;
        let myColor = "#3b82f6"; // Default blue
        
        // --- STARTUP ---
        function generateShortId() { return Math.random().toString(36).substr(2, 6).toUpperCase(); }

        function startApp() {
            const nameInput = document.getElementById('username-input').value.trim();
            if(!nameInput) return alert("Please enter a name!");
            myName = nameInput;
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            initializePeer();
        }

        function initializePeer() {
            const shortId = generateShortId();
            document.getElementById('my-id').innerText = shortId;
            peer = new Peer(shortId);
            peer.on('connection', (c) => handleConnection(c));
            peer.on('error', (err) => { if(err.type === 'unavailable-id') initializePeer(); });
        }

        function copyId() {
            navigator.clipboard.writeText(document.getElementById('my-id').innerText);
            alert("ID Copied!");
        }

        // --- THEME COLOR ---
        function changeTheme(color) {
            document.documentElement.style.setProperty('--primary', color);
            document.documentElement.style.setProperty('--outgoing', color);
            myColor = color;
        }

        // --- CONNECTION HANDLER ---
        document.getElementById('connect-btn').addEventListener('click', () => {
            const friendId = document.getElementById('friend-id-input').value.trim().toUpperCase();
            if(friendId) { handleConnection(peer.connect(friendId)); }
        });

        function handleConnection(connection) {
            conn = connection;
            conn.on('open', () => {
                document.getElementById('conn-panel').classList.add('collapsed');
                document.getElementById('status-bar').style.display = 'flex';
                conn.send({ type: 'info', name: myName });
            });

            conn.on('data', (data) => {
                if(data.type === 'text') { addMessage(friendName, data.content, 'incoming', data.id); } 
                else if (data.type === 'file') { addFile(friendName, data.content, data.fileName, data.fileType, 'incoming'); }
                else if (data.type === 'audio') { addAudio(friendName, data.content, 'incoming'); }
                else if (data.type === 'info') { friendName = data.name; document.getElementById('connection-status-text').innerText = `Connected with ${friendName}`; }
                else if (data.type === 'typing') { showTyping(data.isTyping); }
                else if (data.type === 'reaction') { addReaction(data.msgId); }
                else if (data.type === 'game-invite') { startGameUI(data.game); }
                else if (data.type === 'game-move') { handleGameMove(data); }
                else if (data.type === 'draw') { drawOnCanvas(data.x0, data.y0, data.x1, data.y1, data.color, false); }
                else if (data.type === 'clear-wb') { clearCanvasLocal(); }
            });
            conn.on('close', () => { alert("Connection Lost"); location.reload(); });
        }

        // --- MESSAGING ---
        const msgInput = document.getElementById('msg-input');
        const chatWindow = document.getElementById('chat-window');
        const gameMenu = document.getElementById('game-menu');
        const emojiPicker = document.getElementById('emoji-picker');

        document.getElementById('send-btn').addEventListener('click', sendMessage);
        msgInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
        
        msgInput.addEventListener('input', (e) => {
            if(e.target.value.trim() === '@') gameMenu.style.display = 'flex'; else gameMenu.style.display = 'none';
            if(conn && conn.open) {
                conn.send({ type: 'typing', isTyping: true });
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => { if(conn) conn.send({ type: 'typing', isTyping: false }); }, 1500);
            }
        });

        function showTyping(isTyping) {
            document.getElementById('typing-indicator').style.opacity = isTyping ? 1 : 0;
            document.getElementById('typing-indicator').innerText = `${friendName} is typing...`;
        }

        function sendMessage() {
            const text = msgInput.value;
            if(!text) return;
            const msgId = Date.now(); // Unique ID for reactions

            if(conn && conn.open) {
                conn.send({ type: 'text', content: text, id: msgId });
                addMessage('You', text, 'outgoing', msgId);
                msgInput.value = ''; gameMenu.style.display = 'none'; emojiPicker.style.display = 'none';
                conn.send({ type: 'typing', isTyping: false });
            }
        }

        function addMessage(sender, text, type, id) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.dataset.id = id;
            div.innerHTML = (type==='incoming' ? `<span class="sender-name">${sender}</span>` : '') + 
                            `${text}<span class="timestamp">${new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span><span class="reaction">‚ù§Ô∏è</span>`;
            
            // Double Tap to Like
            div.addEventListener('dblclick', () => {
                div.classList.add('liked');
                if(conn && conn.open) conn.send({ type: 'reaction', msgId: id });
            });

            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function addReaction(id) {
            const msgs = document.querySelectorAll('.message');
            msgs.forEach(m => { if(m.dataset.id == id) m.classList.add('liked'); });
        }

        function clearChat() { if(confirm("Clear chat?")) chatWindow.innerHTML = ''; }

        // --- FILE & IMAGE HANDLING ---
        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const base64 = event.target.result;
                addFile('You', base64, file.name, file.type, 'outgoing');
                if(conn && conn.open) conn.send({ type: 'file', content: base64, fileName: file.name, fileType: file.type });
            };
            reader.readAsDataURL(file);
        });

        function addFile(sender, src, name, type, side) {
            const div = document.createElement('div');
            div.className = `message ${side}`;
            const nameLabel = side === 'incoming' ? `<span class="sender-name">${sender}</span>` : '';
            
            let contentHtml = '';
            if(type.startsWith('image/')) {
                // Image: Click to Download
                contentHtml = `<img src="${src}" class="msg-image" onclick="downloadFile('${src}', '${name}')" title="Tap to Download">`;
            } else {
                // Other Files
                contentHtml = `<div class="file-attachment" onclick="downloadFile('${src}', '${name}')">
                    <span class="file-icon">üìÑ</span> <span class="file-name">${name}</span> <span style="font-size:0.8em">‚¨áÔ∏è</span>
                </div>`;
            }

            div.innerHTML = `${nameLabel}${contentHtml}<span class="timestamp">${new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>`;
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function downloadFile(url, name) {
            const a = document.createElement('a');
            a.href = url; a.download = name; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        function addAudio(sender, src, side) {
            const div = document.createElement('div'); div.className = `message ${side}`;
            div.innerHTML = (side==='incoming'?`<span class="sender-name">${sender}</span>`:'') + `<audio controls src="${src}"></audio><span class="timestamp">${new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>`;
            chatWindow.appendChild(div); chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // --- AUDIO RECORDING ---
        let mediaRecorder, audioChunks = [], isRecording = false;
        document.getElementById('mic-btn').addEventListener('click', async () => {
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream); audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            addAudio('You', e.target.result, 'outgoing');
                            if(conn) conn.send({ type: 'audio', content: e.target.result });
                        };
                        reader.readAsDataURL(new Blob(audioChunks, { type: 'audio/wav' }));
                    };
                    mediaRecorder.start(); isRecording = true; document.getElementById('mic-btn').classList.add('recording');
                } catch(err) { alert("Mic Error (Check HTTPS): " + err); }
            } else {
                mediaRecorder.stop(); isRecording = false; document.getElementById('mic-btn').classList.remove('recording');
            }
        });

        // --- EMOJI ---
        function toggleEmoji() { emojiPicker.style.display = emojiPicker.style.display === 'grid' ? 'none' : 'grid'; }
        function insertEmoji(e) { msgInput.value += e; msgInput.focus(); }

        // --- GAMES & WHITEBOARD ---
        let activeGame = null;
        let tttState = Array(9).fill(null), myTurn = false, mySymbol = 'X';
        let myRPS = null, oppRPS = null;

        function initiateGame(game) {
            gameMenu.style.display = 'none'; msgInput.value = '';
            if(conn && conn.open) {
                myTurn = true; mySymbol = 'X';
                conn.send({ type: 'game-invite', game: game });
                startGameUI(game);
            }
        }

        function startGameUI(game) {
            activeGame = game;
            document.getElementById('game-overlay').style.display = 'flex';
            document.getElementById('ttt-container').style.display = 'none';
            document.getElementById('rps-container').style.display = 'none';
            document.getElementById('wb-container').style.display = 'none';
            document.getElementById('wb-tools').style.display = 'none';

            if(game === 'tictactoe') {
                document.getElementById('game-title').innerText = "Tic Tac Toe";
                document.getElementById('ttt-container').style.display = 'block';
                tttState.fill(null); renderTTT();
                updateStatus(myTurn ? "Your Turn" : `${friendName}'s Turn`);
            } else if (game === 'rps') {
                document.getElementById('game-title').innerText = "Rock Paper Scissors";
                document.getElementById('rps-container').style.display = 'block';
                updateStatus("Choose your weapon...");
            } else if (game === 'whiteboard') {
                document.getElementById('game-title').innerText = "Shared Whiteboard";
                document.getElementById('wb-container').style.display = 'block';
                document.getElementById('wb-tools').style.display = 'flex';
                initWhiteboard();
                updateStatus("Draw something!");
            }
        }

        function closeGame() { document.getElementById('game-overlay').style.display = 'none'; activeGame = null; }
        function updateStatus(msg) { document.getElementById('game-status').innerText = msg; }
        function handleGameMove(data) {
            if(data.game === 'tictactoe') { tttState[data.index] = data.symbol; renderTTT(); if(!checkWinner(tttState)) { myTurn = true; updateStatus("Your Turn"); } }
            else if (data.game === 'rps') { oppRPS = data.move; if(myRPS) resolveRPS(); else updateStatus(`${friendName} chose.`); }
        }

        // TTT Logic
        function renderTTT() {
            const b = document.getElementById('ttt-board'); b.innerHTML = '';
            tttState.forEach((v, i) => {
                const c = document.createElement('div'); c.className = 'cell'; c.innerText = v||'';
                c.style.color = v === 'X' ? '#ef4444' : '#3b82f6';
                c.onclick = () => {
                    if(!myTurn || tttState[i] || !conn) return;
                    tttState[i] = mySymbol; renderTTT(); myTurn = false; updateStatus(`${friendName}'s Turn`);
                    conn.send({ type: 'game-move', game: 'tictactoe', index: i, symbol: mySymbol });
                    checkWinner(tttState);
                };
                b.appendChild(c);
            });
        }
        function checkWinner(bd) {
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for(let w of wins) { if(bd[w[0]] && bd[w[0]]===bd[w[1]] && bd[w[0]]===bd[w[2]]) { alert((bd[w[0]]===mySymbol?"You":"Friend")+" Win!"); return true; } }
            if(!bd.includes(null)) { alert("Draw!"); return true; } return false;
        }

        // RPS Logic
        function playRPS(m) { if(myRPS)return; myRPS=m; updateStatus("Waiting..."); conn.send({type:'game-move',game:'rps',move:m}); if(oppRPS) resolveRPS(); }
        function resolveRPS() {
            let res = myRPS===oppRPS ? "Draw!" : (myRPS==='rock'&&oppRPS==='scissors'||myRPS==='paper'&&oppRPS==='rock'||myRPS==='scissors'&&oppRPS==='paper') ? "You Win!" : "Friend Wins!";
            updateStatus(res); setTimeout(()=>{myRPS=null;oppRPS=null;updateStatus("Play again?");},3000);
        }

        // --- SHARED WHITEBOARD LOGIC ---
        let canvas, ctx, drawing = false, lastX = 0, lastY = 0;
        
        function initWhiteboard() {
            canvas = document.getElementById('wb-canvas');
            ctx = canvas.getContext('2d');
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width; canvas.height = rect.height;
            
            canvas.addEventListener('mousedown', (e) => startDraw(e));
            canvas.addEventListener('mousemove', (e) => draw(e));
            canvas.addEventListener('mouseup', stopDraw);
            canvas.addEventListener('mouseout', stopDraw);
            // Touch support
            canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDraw(e.touches[0]); });
            canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e.touches[0]); });
            canvas.addEventListener('touchend', stopDraw);
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            return { x: e.clientX - rect.left, y: e.clientY - rect.top };
        }

        function startDraw(e) { drawing = true; const pos = getPos(e); lastX = pos.x; lastY = pos.y; }
        
        function draw(e) {
            if(!drawing) return;
            const pos = getPos(e);
            drawOnCanvas(lastX, lastY, pos.x, pos.y, myColor, true);
            lastX = pos.x; lastY = pos.y;
        }

        function stopDraw() { drawing = false; }

        function drawOnCanvas(x0, y0, x1, y1, color, emit) {
            ctx.beginPath(); ctx.moveTo(x0, y0); ctx.lineTo(x1, y1);
            ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.stroke();
            if(emit && conn) conn.send({ type: 'draw', x0, y0, x1, y1, color });
        }

        function clearWhiteboard() {
            clearCanvasLocal();
            if(conn) conn.send({ type: 'clear-wb' });
        }
        function clearCanvasLocal() { ctx.clearRect(0,0,canvas.width,canvas.height); }

    </script>
</body>
</html>