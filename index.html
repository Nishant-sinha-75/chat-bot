<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethereal Chat - V3</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-color: #0f0f0f;
            --chat-bg: #1a1a1a;
            --primary: #3b82f6;
            --text: #e0e0e0;
            --incoming: #262626;
            --outgoing: var(--primary);
            --danger: #ef4444;
            --ghost: #8e44ad;
        }

        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-color); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- SETUP SCREEN --- */
        #setup-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .setup-box { background: #1e1e1e; padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #333; display: flex; flex-direction: column; align-items: center; gap: 15px;}
        .setup-box input[type="text"] { padding: 10px; border-radius: 10px; border: 1px solid #444; background: #333; color: white; width: 200px; text-align: center; font-size: 1rem; }
        
        /* Avatar Upload */
        .avatar-upload { width: 80px; height: 80px; border-radius: 50%; background: #333; border: 2px dashed #555; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; position: relative; }
        .avatar-upload img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .avatar-upload:hover { border-color: var(--primary); }

        /* --- HEADER --- */
        .header { padding: 15px 20px; background: #1a1a1a; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #333; }
        .app-title {
            font-size: 1.5rem; font-weight: 800;
            background: linear-gradient(90deg, var(--primary), #ffffff);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .header-actions { display: flex; align-items: center; gap: 15px; }
        .icon-btn { background: none; border: none; cursor: pointer; color: #888; font-size: 1.2rem; transition: 0.2s; position: relative; display: flex; align-items: center; justify-content: center; }
        .icon-btn:hover { color: white; transform: scale(1.1); }
        .icon-btn.active-ghost { color: var(--danger); text-shadow: 0 0 10px var(--danger); animation: pulse 2s infinite; }
        
        #color-picker-input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        /* --- CHAT AREA --- */
        #chat-window { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }

        .msg-row { display: flex; gap: 10px; max-width: 80%; align-items: flex-end; }
        .msg-row.outgoing { align-self: flex-end; flex-direction: row-reverse; }
        .msg-row.incoming { align-self: flex-start; }

        .chat-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; background: #333; border: 1px solid #444; flex-shrink: 0; }

        .message {
            padding: 10px 15px; border-radius: 18px; word-wrap: break-word; font-size: 15px; position: relative; line-height: 1.4; user-select: none;
            background: var(--incoming); color: var(--text); min-width: 60px;
        }
        .msg-row.outgoing .message { background: var(--outgoing); color: white; border-bottom-right-radius: 4px; }
        .msg-row.incoming .message { background: var(--incoming); border-bottom-left-radius: 4px; }

        .timestamp { font-size: 0.65em; opacity: 0.7; text-align: right; margin-top: 4px; display: block; }
        .reaction { position: absolute; bottom: -10px; right: -5px; background: #2d2d2d; border-radius: 50%; padding: 2px 5px; font-size: 0.8rem; border: 1px solid #444; display: none; z-index: 2; }
        .message.liked .reaction { display: block; }

        /* Reply Button (Hover) */
        .reply-btn { opacity: 0; transition: 0.2s; font-size: 0.9rem; cursor: pointer; color: #888; margin-bottom: 5px; }
        .msg-row:hover .reply-btn { opacity: 1; }
        .reply-btn:hover { color: var(--primary); }

        /* Quoted Message */
        .quote-block {
            background: rgba(0,0,0,0.2); border-left: 3px solid rgba(255,255,255,0.5);
            padding: 5px 8px; font-size: 0.85em; margin-bottom: 5px; border-radius: 4px;
            display: flex; flex-direction: column; opacity: 0.9;
        }
        .quote-sender { font-weight: bold; font-size: 0.8em; margin-bottom: 2px; }

        /* Ghost Mode Style */
        .message.ghost-msg { border: 1px solid var(--danger); }
        .ghost-timer { font-size: 0.7em; color: var(--danger); font-weight: bold; display: block; margin-top: 2px; }

        /* --- INPUT AREA --- */
        .input-wrapper { background: #1a1a1a; display: flex; flex-direction: column; }
        
        #reply-preview-bar {
            background: #252525; padding: 8px 20px; display: none; align-items: center; justify-content: space-between; border-top: 1px solid #333; font-size: 0.9em; color: #ccc; border-left: 4px solid var(--primary);
        }

        .input-area { padding: 15px 20px; display: flex; gap: 10px; position: relative; align-items: center; }
        input[type="text"] { padding: 12px; border-radius: 25px; border: none; outline: none; background: #2d2d2d; color: white; flex: 1; }
        
        .btn-primary { padding: 10px 20px; border-radius: 25px; border: none; background: var(--primary); color: white; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-primary:hover { opacity: 0.9; }

        .tool-btn { background: none; border: none; font-size: 1.3rem; cursor: pointer; color: #888; padding: 0 5px; transition: 0.2s; }
        .tool-btn:hover { color: white; transform: scale(1.1); }
        .recording { color: var(--danger) !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- MENUS (Unchanged styling) --- */
        #game-menu { position: absolute; bottom: 80px; left: 20px; background: #262626; border: 1px solid #444; border-radius: 15px; padding: 10px; display: none; flex-direction: column; gap: 5px; width: 200px; box-shadow: 0 -10px 30px rgba(0,0,0,0.6); z-index: 10; }
        #emoji-picker { position: absolute; bottom: 80px; left: 60px; background: #262626; border: 1px solid #444; border-radius: 15px; padding: 10px; display: none; grid-template-columns: repeat(5, 1fr); gap: 10px; width: 220px; box-shadow: 0 -10px 30px rgba(0,0,0,0.6); z-index: 10; }
        .emoji-item { font-size: 1.5rem; cursor: pointer; text-align: center; }
        .emoji-item:hover { transform: scale(1.2); }
        .game-option { padding: 10px; border-radius: 10px; background: #333; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        .game-option:hover { background: var(--primary); }

        /* --- MEDIA STYLING --- */
        .msg-image { width: 100%; max-width: 250px; height: 150px; object-fit: cover; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); margin-top: 5px; display: block; cursor: pointer; }
        .file-attachment { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; margin-top: 5px; display: flex; align-items: center; gap: 10px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); }
        audio { max-width: 200px; height: 35px; margin-top: 5px; border-radius: 20px; }

        /* --- CONNECTION PANEL --- */
        .connection-panel { background: #161616; padding: 15px; display: flex; gap: 10px; align-items: center; border-bottom: 1px solid #222; transition: all 0.5s ease; max-height: 100px; }
        .connection-panel.collapsed { max-height: 0; padding: 0 15px; opacity: 0; pointer-events: none; border: none; }
        .id-display { font-family: monospace; background: #333; padding: 5px 10px; border-radius: 5px; letter-spacing: 2px; color: #fff; cursor: pointer; border: 1px solid #444; font-size: 0.9rem; }
        .status-bar { padding: 5px 20px; background: #059669; font-size: 0.8em; display: none; justify-content: space-between; align-items: center; color: white; font-weight: bold; }
        .typing-indicator { font-size: 0.75rem; color: #888; padding: 0 20px; margin-top: 5px; font-style: italic; height: 15px; opacity: 0; transition: opacity 0.3s; }

        /* --- OVERLAYS --- */
        #game-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        .close-game { position: absolute; top: 20px; right: 20px; background: #ef4444; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; }
        .ttt-board { display: grid; grid-template-columns: repeat(3, 80px); gap: 5px; margin-top: 20px; }
        .cell { width: 80px; height: 80px; background: #333; display: flex; align-items: center; justify-content: center; font-size: 2.5em; cursor: pointer; border-radius: 5px;}
        .rps-board { display: flex; gap: 20px; margin-top: 20px; }
        .rps-btn { width: 90px; height: 90px; border-radius: 50%; border: 3px solid #555; background: #222; font-size: 30px; cursor: pointer; transition: 0.2s; }
        .rps-btn:hover { border-color: var(--primary); transform: scale(1.1); }
        #wb-container { width: 90%; height: 70%; background: white; border-radius: 10px; overflow: hidden; position: relative; cursor: crosshair; }
        canvas { display: block; width: 100%; height: 100%; }

    </style>
</head>
<body>

    <div id="setup-screen">
        <div class="setup-box">
            <h2 class="app-title" style="font-size: 2rem;">Ethereal Chat</h2>
            
            <label class="avatar-upload" title="Upload Profile Picture">
                <img id="avatar-preview" src="" alt="">
                <span id="avatar-placeholder" style="font-size: 2rem; color:#888;">üì∑</span>
                <input type="file" id="avatar-input" hidden accept="image/*">
            </label>

            <input type="text" id="username-input" placeholder="Enter Your Name">
            <button class="btn-primary" onclick="startApp()">Start Chatting</button>
        </div>
    </div>

    <div id="main-app" style="display:none; height:100%; flex-direction:column;">
        
        <div class="header">
            <div class="app-title">Ethereal Chat</div>
            <div class="header-actions">
                <button class="icon-btn" id="ghost-btn" onclick="toggleGhostMode()" title="Ghost Mode: Auto-delete messages">üëª</button>
                
                <button class="icon-btn" title="Change Theme Color">
                    üé®<input type="color" id="color-picker-input" onchange="changeTheme(this.value)">
                </button>
                
                <div style="display:flex; align-items:center; gap:5px;">
                    <span style="font-size:0.8rem; color:#888;">ID:</span>
                    <span id="my-id" class="id-display" onclick="copyId()" title="Click to Copy">...</span>
                </div>
                
                <button class="icon-btn" onclick="clearChat()" title="Clear Chat History">üóëÔ∏è</button>
            </div>
        </div>

        <div class="connection-panel" id="conn-panel">
            <input type="text" id="friend-id-input" placeholder="Enter Friend's Short ID">
            <button class="btn-primary" id="connect-btn">Connect</button>
        </div>

        <div id="status-bar" class="status-bar">
            <span id="connection-status-text">Connected</span>
            <button onclick="location.reload()" style="background:none; border:none; color:white; cursor:pointer; font-weight:bold;">‚úï</button>
        </div>

        <div id="chat-window"></div>

        <div id="typing-indicator" class="typing-indicator"></div>

        <div class="input-wrapper">
            <div id="reply-preview-bar">
                <span id="reply-text-preview">Replying to...</span>
                <button onclick="cancelReply()" style="background:none; border:none; color:#ef4444; cursor:pointer;">‚úï</button>
            </div>

            <div class="input-area">
                <div id="game-menu">
                    <div class="game-option" onclick="initiateGame('tictactoe')">‚≠ï‚ùå Tic Tac Toe</div>
                    <div class="game-option" onclick="initiateGame('rps')">‚úÇÔ∏è Rock Paper Scissors</div>
                    <div class="game-option" onclick="initiateGame('whiteboard')">‚úèÔ∏è Draw Together</div>
                </div>

                <div id="emoji-picker">
                    <div class="emoji-item" onclick="insertEmoji('üòÄ')">üòÄ</div>
                    <div class="emoji-item" onclick="insertEmoji('üòÇ')">üòÇ</div>
                    <div class="emoji-item" onclick="insertEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</div>
                    <div class="emoji-item" onclick="insertEmoji('ü•∫')">ü•∫</div>
                    <div class="emoji-item" onclick="insertEmoji('üòé')">üòé</div>
                    <div class="emoji-item" onclick="insertEmoji('üëç')">üëç</div>
                    <div class="emoji-item" onclick="insertEmoji('üéâ')">üéâ</div>
                    <div class="emoji-item" onclick="insertEmoji('üî•')">üî•</div>
                    <div class="emoji-item" onclick="insertEmoji('üíÄ')">üíÄ</div>
                </div>
                
                <button class="tool-btn" onclick="toggleEmoji()">üòÄ</button>
                <button class="tool-btn" onclick="document.getElementById('file-input').click()">üìé</button>
                <button class="tool-btn" id="mic-btn">üé§</button>

                <input type="file" id="file-input" hidden>
                <input type="text" id="msg-input" placeholder="Type a message... (@ for menu)">
                <button id="send-btn" class="btn-primary">‚û§</button>
            </div>
        </div>
    </div>

    <div id="game-overlay">
        <button class="close-game" onclick="closeGame()">Exit</button>
        <h2 id="game-title" style="color:white;">Game</h2>
        <div id="game-status" style="color:#aaa; margin-bottom:10px;">Waiting...</div>
        <div id="ttt-container" style="display:none;"><div class="ttt-board" id="ttt-board"></div></div>
        <div id="rps-container" style="display:none;"><div class="rps-board">
            <button class="rps-btn" onclick="playRPS('rock')">ü™®</button><button class="rps-btn" onclick="playRPS('paper')">üìÉ</button><button class="rps-btn" onclick="playRPS('scissors')">‚úÇÔ∏è</button>
        </div></div>
        <div id="wb-container" style="display:none;"><canvas id="wb-canvas"></canvas></div>
        <div id="wb-tools" style="display:none; margin-top:10px;"><button onclick="clearWhiteboard()" style="background:red; color:white; border:none; padding:5px; border-radius:5px;">Clear</button></div>
    </div>

    <script>
        let peer, conn;
        let myName = "User", friendName = "Friend";
        let myAvatar = null, friendAvatar = null; // Base64 strings
        let typingTimeout;
        let myColor = "#3b82f6";
        let isGhostMode = false;
        let replyingTo = null; // { id, text, sender }

        // --- AVATAR HANDLING ---
        document.getElementById('avatar-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Resize image to small size for performance (canvas)
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxSize = 100; // 100x100 max
                        let width = img.width, height = img.height;
                        if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; }} 
                        else { if (height > maxSize) { width *= maxSize / height; height = maxSize; }}
                        canvas.width = width; canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        myAvatar = canvas.toDataURL('image/jpeg', 0.8);
                        document.getElementById('avatar-preview').src = myAvatar;
                        document.getElementById('avatar-preview').style.display = 'block';
                        document.getElementById('avatar-placeholder').style.display = 'none';
                    };
                    img.src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        });

        // --- STARTUP ---
        function generateShortId() { return Math.random().toString(36).substr(2, 6).toUpperCase(); }

        function startApp() {
            const nameInput = document.getElementById('username-input').value.trim();
            if(!nameInput) return alert("Please enter a name!");
            myName = nameInput;
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            initializePeer();
        }

        function initializePeer() {
            const shortId = generateShortId();
            document.getElementById('my-id').innerText = shortId;
            peer = new Peer(shortId);
            peer.on('connection', (c) => handleConnection(c));
            peer.on('error', (err) => { if(err.type === 'unavailable-id') initializePeer(); });
        }

        // --- GHOST MODE ---
        function toggleGhostMode() {
            isGhostMode = !isGhostMode;
            const btn = document.getElementById('ghost-btn');
            if(isGhostMode) btn.classList.add('active-ghost'); else btn.classList.remove('active-ghost');
        }

        // --- REPLY LOGIC ---
        function setReply(id, text, sender) {
            replyingTo = { id, text, sender };
            document.getElementById('reply-preview-bar').style.display = 'flex';
            document.getElementById('reply-text-preview').innerText = `Replying to ${sender}: ${text.substring(0, 30)}...`;
            document.getElementById('msg-input').focus();
        }

        function cancelReply() {
            replyingTo = null;
            document.getElementById('reply-preview-bar').style.display = 'none';
        }

        // --- CONNECTION ---
        document.getElementById('connect-btn').addEventListener('click', () => {
            const friendId = document.getElementById('friend-id-input').value.trim().toUpperCase();
            if(friendId) { handleConnection(peer.connect(friendId)); }
        });

        function handleConnection(connection) {
            conn = connection;
            conn.on('open', () => {
                document.getElementById('conn-panel').classList.add('collapsed');
                document.getElementById('status-bar').style.display = 'flex';
                // Send Name AND Avatar
                conn.send({ type: 'info', name: myName, avatar: myAvatar });
            });

            conn.on('data', (data) => {
                if(data.type === 'info') {
                    friendName = data.name;
                    friendAvatar = data.avatar;
                    document.getElementById('connection-status-text').innerText = `Connected with ${friendName}`;
                }
                else if(data.type === 'text') { 
                    addMessage(friendName, data.content, 'incoming', data.id, data.replyContext, data.isGhost); 
                } 
                else if (data.type === 'file') { 
                    addFile(friendName, data.content, data.fileName, data.fileType, 'incoming', data.isGhost); 
                }
                else if (data.type === 'audio') { 
                    addAudio(friendName, data.content, 'incoming', data.isGhost); 
                }
                else if (data.type === 'typing') { showTyping(data.isTyping); }
                else if (data.type === 'reaction') { addReaction(data.msgId); }
                else if (data.type === 'game-invite') { startGameUI(data.game); }
                else if (data.type === 'game-move') { handleGameMove(data); }
                else if (data.type === 'draw') { drawOnCanvas(data.x0, data.y0, data.x1, data.y1, data.color, false); }
                else if (data.type === 'clear-wb') { clearCanvasLocal(); }
            });
            conn.on('close', () => { alert("Connection Lost"); location.reload(); });
        }

        // --- MESSAGING ---
        const msgInput = document.getElementById('msg-input');
        const chatWindow = document.getElementById('chat-window');
        const gameMenu = document.getElementById('game-menu');

        document.getElementById('send-btn').addEventListener('click', sendMessage);
        msgInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
        
        msgInput.addEventListener('input', (e) => {
            if(e.target.value.trim() === '@') gameMenu.style.display = 'flex'; else gameMenu.style.display = 'none';
            if(conn && conn.open) {
                conn.send({ type: 'typing', isTyping: true });
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => { if(conn) conn.send({ type: 'typing', isTyping: false }); }, 1500);
            }
        });

        function showTyping(isTyping) {
            document.getElementById('typing-indicator').style.opacity = isTyping ? 1 : 0;
            document.getElementById('typing-indicator').innerText = `${friendName} is typing...`;
        }

        function sendMessage() {
            const text = msgInput.value;
            if(!text) return;
            const msgId = Date.now(); 

            if(conn && conn.open) {
                const payload = { 
                    type: 'text', content: text, id: msgId, 
                    isGhost: isGhostMode, replyContext: replyingTo 
                };
                conn.send(payload);
                addMessage('You', text, 'outgoing', msgId, replyingTo, isGhostMode);
                
                msgInput.value = ''; gameMenu.style.display = 'none'; document.getElementById('emoji-picker').style.display='none';
                cancelReply(); // Reset reply state
                conn.send({ type: 'typing', isTyping: false });
            }
        }

        function createMsgRow(type, sender) {
            const row = document.createElement('div');
            row.className = `msg-row ${type}`;
            
            // Add Avatar
            const img = document.createElement('img');
            img.className = 'chat-avatar';
            if(type === 'incoming') img.src = friendAvatar || 'https://via.placeholder.com/35?text=' + sender[0];
            else img.src = myAvatar || 'https://via.placeholder.com/35?text=' + sender[0];
            
            // Reply Button (Arrow)
            const replyBtn = document.createElement('div');
            replyBtn.className = 'reply-btn';
            replyBtn.innerHTML = '‚Ü©Ô∏è';
            
            if(type === 'incoming') { row.appendChild(img); row.appendChild(replyBtn); }
            else { row.appendChild(img); row.appendChild(replyBtn); } // Append bubble later
            
            return { row, replyBtn }; // Return row and the reply btn reference
        }

        function addMessage(sender, text, type, id, replyContext, ghost) {
            const { row, replyBtn } = createMsgRow(type, sender);
            
            const bubble = document.createElement('div');
            bubble.className = 'message' + (ghost ? ' ghost-msg' : '');
            bubble.dataset.id = id;

            // Quote Block
            let quoteHtml = '';
            if(replyContext) {
                quoteHtml = `<div class="quote-block"><span class="quote-sender">${replyContext.sender}</span><span>${replyContext.text.substring(0,40)}...</span></div>`;
            }

            // Ghost Timer Text
            let ghostHtml = ghost ? `<span class="ghost-timer">üí£ Self-destructing in 10s</span>` : '';

            bubble.innerHTML = `${quoteHtml}${text}${ghostHtml}<span class="timestamp">${new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span><span class="reaction">‚ù§Ô∏è</span>`;

            // Interactions
            bubble.addEventListener('dblclick', () => { bubble.classList.add('liked'); if(conn) conn.send({type:'reaction', msgId:id}); });
            replyBtn.onclick = () => setReply(id, text, sender);

            // Insert Bubble in correct order (flex-direction handles visual order)
            if(type === 'incoming') row.appendChild(bubble); 
            else row.insertBefore(bubble, row.children[1]); // Insert before avatar for outgoing (row-reverse)

            chatWindow.appendChild(row);
            chatWindow.scrollTop = chatWindow.scrollHeight;

            // Ghost Logic
            if(ghost) {
                setTimeout(() => {
                    row.style.opacity = '0';
                    setTimeout(() => row.remove(), 1000);
                }, 10000); // 10 seconds
            }
        }

        function addReaction(id) {
            const msgs = document.querySelectorAll('.message');
            msgs.forEach(m => { if(m.dataset.id == id) m.classList.add('liked'); });
        }

        // --- FILES & AUDIO (With Ghost Support) ---
        function addFile(sender, src, name, fType, side, ghost) {
            const { row, replyBtn } = createMsgRow(side, sender);
            const bubble = document.createElement('div');
            bubble.className = 'message' + (ghost ? ' ghost-msg' : '');
            
            let content = fType.startsWith('image/') ? `<img src="${src}" class="msg-image" onclick="downloadFile('${src}','${name}')">` : 
            `<div class="file-attachment" onclick="downloadFile('${src}','${name}')"><span style="font-size:1.5rem">üìÑ</span> ${name}</div>`;
            
            let ghostHtml = ghost ? `<span class="ghost-timer">üí£ 10s</span>` : '';
            bubble.innerHTML = `${content}${ghostHtml}<span class="timestamp">${new Date().toLocaleTimeString()}</span>`;
            
            replyBtn.onclick = () => setReply(Date.now(), `[File: ${name}]`, sender);

            if(side === 'incoming') row.appendChild(bubble); else row.insertBefore(bubble, row.children[1]);
            chatWindow.appendChild(row); chatWindow.scrollTop = chatWindow.scrollHeight;
            if(ghost) setTimeout(() => row.remove(), 10000);
        }

        function addAudio(sender, src, side, ghost) {
            const { row } = createMsgRow(side, sender);
            const bubble = document.createElement('div');
            bubble.className = 'message' + (ghost ? ' ghost-msg' : '');
            let ghostHtml = ghost ? `<span class="ghost-timer">üí£ 10s</span>` : '';
            bubble.innerHTML = `<audio controls src="${src}"></audio>${ghostHtml}<span class="timestamp">${new Date().toLocaleTimeString()}</span>`;
            if(side === 'incoming') row.appendChild(bubble); else row.insertBefore(bubble, row.children[1]);
            chatWindow.appendChild(row); chatWindow.scrollTop = chatWindow.scrollHeight;
            if(ghost) setTimeout(() => row.remove(), 10000);
        }

        // --- HELPERS (Copy, Clear, Download) ---
        function copyId() { navigator.clipboard.writeText(document.getElementById('my-id').innerText); alert("ID Copied!"); }
        function clearChat() { if(confirm("Clear chat?")) chatWindow.innerHTML = ''; }
        function downloadFile(url, name) { const a = document.createElement('a'); a.href = url; a.download = name; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
        function changeTheme(c) { document.documentElement.style.setProperty('--primary', c); document.documentElement.style.setProperty('--outgoing', c); }
        
        // --- EXISTING GAME & TOOLS LOGIC ---
        // (Copied from previous valid version to ensure stability)
        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const b64 = event.target.result;
                addFile('You', b64, file.name, file.type, 'outgoing', isGhostMode);
                if(conn) conn.send({ type: 'file', content: b64, fileName: file.name, fileType: file.type, isGhost: isGhostMode });
            };
            reader.readAsDataURL(file);
        });
        
        let mediaRec, chunks = [], isRec = false;
        document.getElementById('mic-btn').addEventListener('click', async () => {
            if (!isRec) {
                try {
                    const s = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRec = new MediaRecorder(s); chunks = [];
                    mediaRec.ondataavailable = e => chunks.push(e.data);
                    mediaRec.onstop = () => {
                        const r = new FileReader();
                        r.onload = (e) => {
                            addAudio('You', e.target.result, 'outgoing', isGhostMode);
                            if(conn) conn.send({ type: 'audio', content: e.target.result, isGhost: isGhostMode });
                        };
                        r.readAsDataURL(new Blob(chunks, { type: 'audio/wav' }));
                    };
                    mediaRec.start(); isRec = true; document.getElementById('mic-btn').classList.add('recording');
                } catch(err) { alert("Mic Error (HTTPS req): " + err); }
            } else { mediaRec.stop(); isRec = false; document.getElementById('mic-btn').classList.remove('recording'); }
        });

        // Games
        let tttState = Array(9).fill(null), myTurn = false, mySymbol = 'X', myRPS = null, oppRPS = null;
        function initiateGame(g) { gameMenu.style.display='none'; msgInput.value=''; if(conn){ myTurn=true; mySymbol='X'; conn.send({type:'game-invite',game:g}); startGameUI(g); } }
        function startGameUI(g) {
            document.getElementById('game-overlay').style.display='flex';
            ['ttt-container','rps-container','wb-container','wb-tools'].forEach(id=>document.getElementById(id).style.display='none');
            if(g==='tictactoe'){ document.getElementById('game-title').innerText="Tic Tac Toe"; document.getElementById('ttt-container').style.display='block'; tttState.fill(null); renderTTT(); document.getElementById('game-status').innerText=myTurn?"Your Turn":"Opponent's Turn"; }
            else if(g==='rps'){ document.getElementById('game-title').innerText="RPS"; document.getElementById('rps-container').style.display='block'; document.getElementById('game-status').innerText="Choose..."; }
            else if(g==='whiteboard'){ document.getElementById('game-title').innerText="Whiteboard"; document.getElementById('wb-container').style.display='block'; document.getElementById('wb-tools').style.display='block'; initWhiteboard(); }
        }
        function closeGame(){document.getElementById('game-overlay').style.display='none';}
        function handleGameMove(d){
            if(d.game==='tictactoe'){ tttState[d.index]=d.symbol; renderTTT(); if(!checkWinner(tttState)){myTurn=true;document.getElementById('game-status').innerText="Your Turn";} }
            else if(d.game==='rps'){ oppRPS=d.move; if(myRPS)resolveRPS(); else document.getElementById('game-status').innerText="Opponent chose."; }
        }
        // TTT
        function renderTTT(){ 
            const b=document.getElementById('ttt-board'); b.innerHTML=''; 
            tttState.forEach((v,i)=>{ 
                const c=document.createElement('div'); c.className='cell'; c.innerText=v||''; c.style.color=v==='X'?'#ef4444':'#3b82f6';
                c.onclick=()=>{if(!myTurn||tttState[i]||!conn)return; tttState[i]=mySymbol; renderTTT(); myTurn=false; document.getElementById('game-status').innerText="Waiting..."; conn.send({type:'game-move',game:'tictactoe',index:i,symbol:mySymbol}); checkWinner(tttState);}
                b.appendChild(c); 
            }); 
        }
        function checkWinner(b){ 
            const w=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]]; 
            for(let c of w){ if(b[c[0]]&&b[c[0]]===b[c[1]]&&b[c[0]]===b[c[2]]){ alert((b[c[0]]===mySymbol?"You":"Friend")+" Win!"); return true; } }
            if(!b.includes(null)){ alert("Draw!"); return true; } return false;
        }
        // RPS
        function playRPS(m){ if(myRPS)return; myRPS=m; document.getElementById('game-status').innerText="Waiting..."; conn.send({type:'game-move',game:'rps',move:m}); if(oppRPS)resolveRPS(); }
        function resolveRPS(){ 
            let r=myRPS===oppRPS?"Draw!":(myRPS==='rock'&&oppRPS==='scissors'||myRPS==='paper'&&oppRPS==='rock'||myRPS==='scissors'&&oppRPS==='paper')?"You Win!":"You Lose!"; 
            document.getElementById('game-status').innerText=r; setTimeout(()=>{myRPS=null;oppRPS=null;document.getElementById('game-status').innerText="Play again?";},3000); 
        }
        // Whiteboard
        let canvas, ctx, drawing=false, lastX=0, lastY=0;
        function initWhiteboard(){ canvas=document.getElementById('wb-canvas'); ctx=canvas.getContext('2d'); const r=canvas.parentElement.getBoundingClientRect(); canvas.width=r.width; canvas.height=r.height; 
            canvas.addEventListener('mousedown',e=>startDraw(e)); canvas.addEventListener('mousemove',e=>draw(e)); canvas.addEventListener('mouseup',()=>drawing=false);
            canvas.addEventListener('touchstart',e=>{e.preventDefault();startDraw(e.touches[0])}); canvas.addEventListener('touchmove',e=>{e.preventDefault();draw(e.touches[0])}); canvas.addEventListener('touchend',()=>drawing=false);
        }
        function startDraw(e){ drawing=true; const r=canvas.getBoundingClientRect(); lastX=e.clientX-r.left; lastY=e.clientY-r.top; }
        function draw(e){ if(!drawing)return; const r=canvas.getBoundingClientRect(); const x=e.clientX-r.left, y=e.clientY-r.top; drawOnCanvas(lastX,lastY,x,y,myColor,true); lastX=x; lastY=y; }
        function drawOnCanvas(x0,y0,x1,y1,c,emit){ ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x1,y1); ctx.strokeStyle=c; ctx.lineWidth=3; ctx.stroke(); if(emit&&conn)conn.send({type:'draw',x0,y0,x1,y1,color:c}); }
        function clearWhiteboard(){ ctx.clearRect(0,0,canvas.width,canvas.height); if(conn)conn.send({type:'clear-wb'}); }
        function clearCanvasLocal(){ if(ctx) ctx.clearRect(0,0,canvas.width,canvas.height); }
        // Emoji
        function toggleEmoji() { document.getElementById('emoji-picker').style.display = document.getElementById('emoji-picker').style.display === 'grid' ? 'none' : 'grid'; }
        function insertEmoji(e) { msgInput.value += e; msgInput.focus(); }

    </script>
</body>
</html>