<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ethereal: Chat & Arcade</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* --- ETHEREAL THEME --- */
        :root { 
            --bg: #050505; 
            --surface: #121212; 
            --surface-light: #1e1e1e;
            --primary: #00f2ea; 
            --secondary: #ff0055; 
            --text: #fff; 
            --text-dim: #888;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .btn-glow { width: 100%; padding: 15px; background: var(--primary); border: none; border-radius: 12px; font-weight: bold; cursor: pointer; box-shadow: 0 0 20px rgba(0,242,234,0.3); color: #000; }
        
        /* --- LOGIN --- */
        #login-screen { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-box { width: 80%; max-width: 300px; text-align: center; }
        .login-input { width: 100%; padding: 15px; background: #222; border: 1px solid #333; color: white; border-radius: 12px; margin-bottom: 20px; text-align: center; font-size: 1.1rem; }

        /* --- APP HEADER --- */
        header { padding: 15px; background: rgba(18,18,18,0.95); border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .brand { font-weight: 800; color: var(--primary); letter-spacing: 2px; }
        .id-badge { font-size: 0.75rem; padding: 6px 12px; background: #222; border-radius: 20px; display: flex; align-items: center; gap: 8px; border: 1px solid #333; cursor: pointer; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: orange; box-shadow: 0 0 5px orange; }
        .dot.online { background: #0f0; box-shadow: 0 0 5px #0f0; }

        /* --- CONTENT AREA (Tabs) --- */
        #main-content { flex: 1; overflow: hidden; position: relative; display: flex; flex-direction: column; }
        
        /* VIEW: CHAT */
        #view-chat { flex: 1; display: flex; flex-direction: column; height: 100%; }
        .conn-bar { padding: 10px; background: var(--surface); display: flex; gap: 8px; border-bottom: 1px solid #333; }
        .conn-input { flex: 1; padding: 10px; background: #000; border: 1px solid #333; color: white; border-radius: 8px; }
        .btn-join { background: #333; color: white; border: none; padding: 0 15px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        
        #chat-feed { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 10px 14px; border-radius: 16px; font-size: 0.95rem; word-wrap: break-word; }
        .mine { align-self: flex-end; background: var(--primary); color: #000; border-bottom-right-radius: 2px; }
        .theirs { align-self: flex-start; background: #222; color: #fff; border-bottom-left-radius: 2px; }
        .sys-msg { align-self: center; font-size: 0.75rem; color: #666; background: #111; padding: 4px 10px; border-radius: 10px; }
        
        .chat-input-area { padding: 10px; background: var(--surface); display: flex; gap: 10px; border-top: 1px solid #333; }
        #msg-input { flex: 1; padding: 12px 15px; background: #000; border: 1px solid #333; color: white; border-radius: 25px; }
        #send-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--primary); border: none; font-size: 1.4rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* VIEW: GAMES (ARCADE) */
        #view-games { flex: 1; display: none; flex-direction: column; background: var(--bg); padding: 20px; overflow-y: auto; }
        
        /* Game List (Column) */
        .game-list { display: flex; flex-direction: column; gap: 15px; }
        .game-card { 
            background: var(--surface-light); border: 1px solid #333; border-radius: 15px; padding: 20px; 
            display: flex; justify-content: space-between; align-items: center; transition: 0.2s;
        }
        .game-card:active { transform: scale(0.98); background: #252525; }
        .game-info h3 { margin: 0; color: white; font-size: 1.1rem; }
        .game-info p { margin: 5px 0 0; color: var(--text-dim); font-size: 0.8rem; }
        .play-btn { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; }

        /* Active Game Board */
        #active-game-container { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        .tictac-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; width: 100%; max-width: 300px; aspect-ratio: 1; }
        .cell { background: #222; border-radius: 10px; border: none; font-size: 2.5rem; font-weight: 800; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; }
        .cell.X { color: var(--primary); text-shadow: 0 0 10px rgba(0,242,234,0.4); }
        .cell.O { color: var(--secondary); text-shadow: 0 0 10px rgba(255,0,85,0.4); }
        .game-status { margin-bottom: 20px; font-size: 1.2rem; font-weight: 600; color: var(--primary); letter-spacing: 1px; }
        .btn-close-game { margin-top: 20px; background: #333; color: #fff; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; }

        /* --- BOTTOM NAV --- */
        .bottom-nav { 
            height: 60px; background: var(--surface); border-top: 1px solid #333; 
            display: flex; justify-content: space-around; align-items: center; 
        }
        .nav-item { 
            flex: 1; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            color: #666; font-size: 0.7rem; gap: 4px; cursor: pointer; transition: 0.2s;
        }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 1.4rem; font-weight: bold; }

    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h1 style="color:white; font-weight:300; letter-spacing:4px; margin-bottom:10px;">ETHEREAL</h1>
            <input type="text" id="username-field" class="login-input" placeholder="Enter Nickname">
            <button class="btn-glow" onclick="enterApp()">START ENGINE</button>
        </div>
    </div>

    <header>
        <div class="brand">ETHEREAL</div>
        <div class="id-badge" onclick="copyId()">
            <div id="status-dot" class="dot"></div>
            <span id="id-text">Offline</span>
        </div>
    </header>

    <div id="main-content">
        
        <div id="view-chat">
            <div class="conn-bar">
                <input id="remote-id" class="conn-input" placeholder="Paste Friend's ID">
                <button class="btn-join" onclick="connectManual()">JOIN</button>
            </div>
            <div id="chat-feed">
                <div class="sys-msg">Welcome to Ethereal. Connect to start.</div>
            </div>
            <div class="chat-input-area">
                <input id="msg-input" type="text" placeholder="Type message..." disabled>
                <button id="send-btn" onclick="sendMessage()" disabled>â†’</button>
            </div>
        </div>

        <div id="view-games">
            
            <div id="game-hub" class="game-list">
                <div class="game-card">
                    <div class="game-info">
                        <h3>Tic Tac Toe</h3>
                        <p>Classic X vs O battle.</p>
                    </div>
                    <button class="play-btn" onclick="inviteGame('tictactoe')">PLAY</button>
                </div>
                
                <div class="game-card" style="opacity:0.5; cursor:not-allowed;">
                    <div class="game-info">
                        <h3>Rock Paper Scissors</h3>
                        <p>Coming Soon</p>
                    </div>
                    <button class="play-btn" style="border-color:#555; color:#555;">LOCKED</button>
                </div>
            </div>

            <div id="active-game-container">
                <div id="game-status-text" class="game-status">Waiting...</div>
                <div class="tictac-grid" id="ttt-grid">
                    <button class="cell" onclick="move(0)"></button>
                    <button class="cell" onclick="move(1)"></button>
                    <button class="cell" onclick="move(2)"></button>
                    <button class="cell" onclick="move(3)"></button>
                    <button class="cell" onclick="move(4)"></button>
                    <button class="cell" onclick="move(5)"></button>
                    <button class="cell" onclick="move(6)"></button>
                    <button class="cell" onclick="move(7)"></button>
                    <button class="cell" onclick="move(8)"></button>
                </div>
                <button class="btn-close-game" onclick="quitGame()">Quit Game</button>
            </div>

        </div>

    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" id="nav-chat" onclick="switchTab('chat')">
            <span class="nav-icon">ðŸ’¬</span>
            <span>CHAT</span>
        </div>
        <div class="nav-item" id="nav-games" onclick="switchTab('games')">
            <span class="nav-icon">ðŸŽ®</span>
            <span>ARCADE</span>
        </div>
    </nav>

    <script>
        // --- DATA ---
        let me = { name: "User", id: null };
        let peer = null;
        let conn = null;
        let activeGame = null; // { symbol: 'X'|'O', turn: bool, board: [] }

        // --- DOM ---
        const ui = {
            login: document.getElementById('login-screen'),
            userField: document.getElementById('username-field'),
            idText: document.getElementById('id-text'),
            dot: document.getElementById('status-dot'),
            chatView: document.getElementById('view-chat'),
            gameView: document.getElementById('view-games'),
            chatFeed: document.getElementById('chat-feed'),
            gameHub: document.getElementById('game-hub'),
            gameBoard: document.getElementById('active-game-container'),
            gameStatus: document.getElementById('game-status-text'),
            tttCells: document.querySelectorAll('.cell'),
            input: document.getElementById('msg-input'),
            send: document.getElementById('send-btn')
        };

        // --- 1. CORE & NAV ---
        function enterApp() {
            const name = ui.userField.value.trim();
            if(!name) return;
            me.name = name;
            ui.login.style.display = 'none';
            initPeer();
        }

        function switchTab(tab) {
            // Update Nav UI
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${tab}`).classList.add('active');

            // Update View UI
            if(tab === 'chat') {
                ui.chatView.style.display = 'flex';
                ui.gameView.style.display = 'none';
            } else {
                ui.chatView.style.display = 'none';
                ui.gameView.style.display = 'flex';
            }
        }

        // --- 2. P2P NETWORKING ---
        function initPeer() {
            peer = new Peer();
            peer.on('open', id => {
                me.id = id;
                ui.dot.classList.add('online');
                ui.idText.innerText = "Copy ID";
                addSystemMsg("System Ready. Share ID to connect.");
            });
            peer.on('connection', c => handleConn(c));
        }

        function connectManual() {
            const id = document.getElementById('remote-id').value.trim();
            if(!id) return;
            addSystemMsg("Connecting...");
            handleConn(peer.connect(id));
        }

        function handleConn(connection) {
            if(conn) conn.close();
            conn = connection;

            conn.on('open', () => {
                ui.input.disabled = false;
                ui.send.disabled = false;
                addSystemMsg("Connected securely!");
                conn.send({ type: 'handshake', name: me.name });
            });

            conn.on('data', data => handleData(data));
            conn.on('close', () => {
                addSystemMsg("Disconnected.");
                ui.input.disabled = true;
                ui.dot.classList.remove('online');
                conn = null;
                quitGame(true); // Force quit game if net lost
            });
        }

        // --- 3. DATA HANDLER ---
        function handleData(data) {
            switch(data.type) {
                case 'handshake': addSystemMsg(`Connected to ${data.name}`); break;
                case 'chat': addMsg(data.text, 'theirs'); break;
                
                // GAME EVENTS
                case 'game-invite':
                    if(confirm(`${data.from} challenged you to Tic Tac Toe!`)) {
                        acceptGame();
                    }
                    break;
                case 'game-accept':
                    startTicTacToe('X'); // Inviter is X
                    break;
                case 'game-move':
                    handleRemoteMove(data.index);
                    break;
                case 'game-quit':
                    quitGame(true);
                    alert("Opponent left the game.");
                    break;
            }
        }

        // --- 4. CHAT FUNCTIONS ---
        function sendMessage() {
            const txt = ui.input.value.trim();
            if(!txt || !conn) return;
            conn.send({ type: 'chat', text: txt });
            addMsg(txt, 'mine');
            ui.input.value = "";
        }

        function addMsg(txt, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerText = txt;
            ui.chatFeed.appendChild(div);
            ui.chatFeed.scrollTop = ui.chatFeed.scrollHeight;
        }

        function addSystemMsg(txt) {
            const div = document.createElement('div');
            div.className = 'sys-msg';
            div.innerText = txt;
            ui.chatFeed.appendChild(div);
        }

        // --- 5. GAME LOGIC (TIC TAC TOE) ---
        function inviteGame(gameName) {
            if(!conn) return alert("Connect to a friend first!");
            conn.send({ type: 'game-invite', from: me.name });
            addSystemMsg("Game invitation sent...");
        }

        function acceptGame() {
            switchTab('games');
            startTicTacToe('O'); // Acceptor is O
            conn.send({ type: 'game-accept' });
        }

        function startTicTacToe(symbol) {
            activeGame = {
                symbol: symbol,
                board: Array(9).fill(null),
                myTurn: symbol === 'X' // X starts
            };

            // Switch UI
            ui.gameHub.classList.add('hidden');
            ui.gameBoard.style.display = 'flex';
            
            // Reset Board
            ui.tttCells.forEach(c => { c.innerText = ""; c.className = "cell"; });
            updateGameStatus();
        }

        function updateGameStatus() {
            if(activeGame.myTurn) {
                ui.gameStatus.innerText = "YOUR TURN";
                ui.gameStatus.style.color = "var(--primary)";
            } else {
                ui.gameStatus.innerText = "THEIR TURN";
                ui.gameStatus.style.color = "#666";
            }
        }

        function move(index) {
            if(!activeGame || !activeGame.myTurn || activeGame.board[index]) return;

            // Make Move
            activeGame.board[index] = activeGame.symbol;
            renderCell(index, activeGame.symbol);
            activeGame.myTurn = false;
            updateGameStatus();

            // Send
            conn.send({ type: 'game-move', index: index });
            checkWin();
        }

        function handleRemoteMove(index) {
            if(!activeGame) return;
            const oppSymbol = activeGame.symbol === 'X' ? 'O' : 'X';
            
            activeGame.board[index] = oppSymbol;
            renderCell(index, oppSymbol);
            activeGame.myTurn = true;
            updateGameStatus();
            checkWin();
        }

        function renderCell(index, symbol) {
            const cell = ui.tttCells[index];
            cell.innerText = symbol;
            cell.classList.add(symbol);
        }

        function checkWin() {
            const b = activeGame.board;
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            
            for(let w of wins) {
                if(b[w[0]] && b[w[0]] === b[w[1]] && b[w[0]] === b[w[2]]) {
                    const winner = b[w[0]];
                    setTimeout(() => {
                        alert(winner === activeGame.symbol ? "VICTORY!" : "DEFEAT!");
                        quitGame();
                    }, 100);
                    return;
                }
            }
            if(!b.includes(null)) {
                setTimeout(() => { alert("DRAW GAME!"); quitGame(); }, 100);
            }
        }

        function quitGame(silent = false) {
            ui.gameBoard.style.display = 'none';
            ui.gameHub.classList.remove('hidden');
            activeGame = null;
            if(!silent && conn) conn.send({ type: 'game-quit' });
        }

        // --- UTILS ---
        function copyId() {
            if(me.id) navigator.clipboard.writeText(me.id).then(() => alert("ID Copied"));
        }
    </script>
</body>
</html>
