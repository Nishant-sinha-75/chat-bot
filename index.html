<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethereal Chat</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-color: #0f0f0f;
            --chat-bg: #1a1a1a;
            --primary: #3b82f6; /* Blueish */
            --gradient-text: linear-gradient(90deg, #6060ff, #9e9eff);
            --text: #e0e0e0;
            --incoming: #262626;
            --outgoing: #2563eb;
        }

        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-color); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- SETUP SCREEN --- */
        #setup-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .setup-box { background: #1e1e1e; padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .setup-box input { padding: 10px; border-radius: 10px; border: 1px solid #444; background: #333; color: white; width: 200px; text-align: center; margin-bottom: 15px; }

        /* --- HEADER --- */
        .header {
            padding: 15px 20px;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #333;
        }

        .app-title {
            font-size: 1.5rem;
            font-weight: 800;
            background: var(--gradient-text);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* --- CONNECTION PANEL --- */
        .connection-panel {
            background: #161616;
            padding: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            border-bottom: 1px solid #222;
            transition: all 0.5s ease;
            max-height: 100px;
        }

        .connection-panel.collapsed {
            max-height: 0; padding: 0 15px; opacity: 0; pointer-events: none; border: none;
        }

        .id-display {
            font-family: monospace;
            background: #333;
            padding: 5px 10px;
            border-radius: 5px;
            letter-spacing: 2px;
            color: #fff;
            cursor: pointer;
            border: 1px solid #444;
        }
        .id-display:active { background: #444; }

        /* --- STATUS & TYPING --- */
        .status-bar {
            padding: 5px 20px;
            background: #059669; /* Green success */
            font-size: 0.8em;
            display: none; 
            justify-content: space-between;
            align-items: center;
            color: rgb(255, 255, 255);
            font-weight: bold;
        }
        
        .typing-indicator {
            font-size: 0.75rem;
            color: #88dbff;
            padding: 0 20px;
            margin-top: 5px;
            font-style: italic;
            height: 15px; /* Fixed height to prevent jump */
            opacity: 0;
            transition: opacity 0.3s;
        }

        /* --- CHAT AREA --- */
        #chat-window {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 75%;
            padding: 10px 15px;
            border-radius: 18px;
            word-wrap: break-word;
            font-size: 15px;
            position: relative;
            line-height: 1.4;
        }

        .incoming { align-self: flex-start; background: var(--incoming); border-bottom-left-radius: 4px; }
        .outgoing { align-self: flex-end; background: var(--outgoing); border-bottom-right-radius: 4px; color: white; }

        .timestamp {
            font-size: 0.65em;
            opacity: 0.7;
            text-align: right;
            margin-top: 4px;
            display: block;
        }

        .sender-name {
            font-size: 0.75em;
            color: #aaa;
            margin-bottom: 2px;
            display: block;
        }

        /* --- IMAGE STYLING --- */
        .msg-image {
            width: 100%;
            max-width: 250px;
            height: 150px; 
            object-fit: cover; 
            border-radius: 20px; 
            border: 1px solid rgba(255,255,255,0.1);
            margin-top: 5px;
            display: block;
        }

        /* --- INPUT --- */
        .input-area {
            padding: 15px 20px;
            background: #1a1a1a;
            display: flex;
            gap: 10px;
            position: relative;
        }

        input[type="text"] {
            padding: 12px;
            border-radius: 25px;
            border: none;
            outline: none;
            background: #2d2d2d;
            color: white;
            flex: 1;
        }
        
        .btn-primary {
            padding: 10px 20px;
            border-radius: 25px;
            border: none;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }
        .btn-primary:hover { opacity: 0.9; }

        /* --- GAME MENU --- */
        #game-menu {
            position: absolute; bottom: 80px; left: 20px;
            background: #262626; border: 1px solid #444; border-radius: 15px;
            padding: 10px; display: none; flex-direction: column; gap: 5px; width: 200px;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.6);
            z-index: 10;
        }
        .game-option {
            padding: 10px; border-radius: 10px; background: #333;
            cursor: pointer; display: flex; align-items: center; gap: 10px;
            font-size: 0.9rem;
        }
        .game-option:hover { background: var(--primary); }

        /* --- GAME OVERLAY --- */
        #game-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95); display: none;
            flex-direction: column; align-items: center; justify-content: center; z-index: 1000;
        }
        .ttt-board { display: grid; grid-template-columns: repeat(3, 80px); gap: 5px; margin-top: 20px; }
        .cell { width: 80px; height: 80px; background: #333; display: flex; align-items: center; justify-content: center; font-size: 2.5em; cursor: pointer; border-radius: 5px;}
        .rps-board { display: flex; gap: 20px; margin-top: 20px; }
        .rps-btn { width: 90px; height: 90px; border-radius: 50%; border: 3px solid #555; background: #222; font-size: 30px; cursor: pointer; transition: 0.2s; }
        .rps-btn:hover { border-color: var(--primary); transform: scale(1.1); }
        .close-game { position: absolute; top: 20px; right: 20px; background: #ef4444; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; }

    </style>
</head>
<body>

    <div id="setup-screen">
        <div class="setup-box">
            <h2 class="app-title" style="font-size: 2rem; margin-bottom: 20px;">Ethereal Chat</h2>
            <input type="text" id="username-input" placeholder="Enter Your Name">
            <br>
            <button class="btn-primary" onclick="startApp()">Start Chatting</button>
        </div>
    </div>

    <div id="main-app" style="display:none; height:100%; flex-direction:column;">
        
        <div class="header">
            <div class="app-title">Ethereal Chat</div>
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:0.8rem; color:#888;">My ID:</span>
                <span id="my-id" class="id-display" onclick="copyId()" title="Click to Copy">...</span>
            </div>
        </div>

        <div class="connection-panel" id="conn-panel">
            <input type="text" id="friend-id-input" placeholder="Enter Friend's Short ID">
            <button class="btn-primary" id="connect-btn">Connect</button>
        </div>

        <div id="status-bar" class="status-bar">
            <span id="connection-status-text">Connected</span>
            <button onclick="location.reload()" style="background:none; border:none; color:white; cursor:pointer; font-weight:bold;">‚úï</button>
        </div>

        <div id="chat-window"></div>

        <div id="typing-indicator" class="typing-indicator"></div>

        <div class="input-area">
            <div id="game-menu">
                <div class="game-option" onclick="initiateGame('tictactoe')">‚≠ï‚ùå Tic Tac Toe</div>
                <div class="game-option" onclick="initiateGame('rps')">‚úÇÔ∏è Rock Paper Scissors</div>
            </div>
            
            <button onclick="document.getElementById('file-input').click()" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">üì∑</button>
            <input type="file" id="file-input" hidden accept="image/*">
            <input type="text" id="msg-input" placeholder="Type a message... (@ for games)">
            <button id="send-btn" class="btn-primary">‚û§</button>
        </div>
    </div>

    <div id="game-overlay">
        <button class="close-game" onclick="closeGame()">Exit</button>
        <h2 id="game-title" style="color:white;">Game</h2>
        <div id="game-status" style="color:#aaa; margin-bottom:10px;">Waiting...</div>
        
        <div id="ttt-container" style="display:none;">
            <div class="ttt-board" id="ttt-board"></div>
        </div>

        <div id="rps-container" style="display:none;">
            <div class="rps-board">
                <button class="rps-btn" onclick="playRPS('rock')">ü™®</button>
                <button class="rps-btn" onclick="playRPS('paper')">üìÉ</button>
                <button class="rps-btn" onclick="playRPS('scissors')">‚úÇÔ∏è</button>
            </div>
        </div>
    </div>

    <script>
        let peer;
        let conn;
        let myName = "User";
        let friendName = "Friend";
        let typingTimeout;
        
        // --- STARTUP LOGIC ---
        function generateShortId() {
            // Generates a random 6-character string (numbers & letters)
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        function startApp() {
            const nameInput = document.getElementById('username-input').value.trim();
            if(!nameInput) return alert("Please enter a name!");
            
            myName = nameInput;
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';

            initializePeer();
        }

        function initializePeer() {
            const shortId = generateShortId();
            document.getElementById('my-id').innerText = shortId;

            peer = new Peer(shortId);

            peer.on('open', (id) => {
                console.log('My Peer ID is: ' + id);
            });

            peer.on('connection', (connection) => {
                handleConnection(connection);
            });

            peer.on('error', (err) => {
                console.error(err);
                if(err.type === 'unavailable-id') {
                    alert("ID collision. Retrying...");
                    initializePeer(); // Retry with new ID
                }
            });
        }

        // --- ID COPY LOGIC ---
        function copyId() {
            const idText = document.getElementById('my-id').innerText;
            navigator.clipboard.writeText(idText).then(() => {
                alert("ID Copied: " + idText);
            });
        }

        // --- CONNECTION HANDLER ---
        document.getElementById('connect-btn').addEventListener('click', () => {
            const friendId = document.getElementById('friend-id-input').value.trim().toUpperCase();
            if(friendId) {
                const connection = peer.connect(friendId);
                handleConnection(connection);
            }
        });

        function handleConnection(connection) {
            conn = connection;

            conn.on('open', () => {
                // UI Update
                document.getElementById('conn-panel').classList.add('collapsed');
                document.getElementById('status-bar').style.display = 'flex';
                
                // Exchange Names
                conn.send({ type: 'info', name: myName });
            });

            conn.on('data', (data) => {
                if(data.type === 'text') {
                    addMessage(friendName, data.content, 'incoming');
                    showTyping(false); // Stop typing indicator on message
                } 
                else if (data.type === 'image') {
                    addImage(friendName, data.content, 'incoming');
                    showTyping(false);
                }
                else if (data.type === 'info') {
                    friendName = data.name;
                    document.getElementById('connection-status-text').innerText = `Connected with ${friendName}`;
                }
                else if (data.type === 'typing') {
                    showTyping(data.isTyping);
                }
                else if (data.type === 'game-invite') {
                    startGameUI(data.game);
                }
                else if (data.type === 'game-move') {
                    handleGameMove(data);
                }
            });
            
            conn.on('close', () => {
                 alert("Connection Lost");
                 location.reload();
            });
        }

        // --- MESSAGING & UI ---
        const msgInput = document.getElementById('msg-input');
        const chatWindow = document.getElementById('chat-window');
        const gameMenu = document.getElementById('game-menu');
        const typingIndicator = document.getElementById('typing-indicator');

        document.getElementById('send-btn').addEventListener('click', sendMessage);
        msgInput.addEventListener('keypress', (e) => {
            if(e.key === 'Enter') sendMessage();
        });

        // Typing & @ Logic
        msgInput.addEventListener('input', (e) => {
            // @ Trigger
            if(e.target.value.trim() === '@') {
                gameMenu.style.display = 'flex';
            } else {
                gameMenu.style.display = 'none';
            }

            // Typing Indicator Logic
            if(conn && conn.open) {
                conn.send({ type: 'typing', isTyping: true });
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    conn.send({ type: 'typing', isTyping: false });
                }, 1500);
            }
        });

        function showTyping(isTyping) {
            if(isTyping) {
                typingIndicator.innerText = `${friendName} is typing...`;
                typingIndicator.style.opacity = 1;
            } else {
                typingIndicator.style.opacity = 0;
            }
        }

        function getTimestamp() {
            return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function sendMessage() {
            const text = msgInput.value;
            if(!text) return;

            // Manual Game Triggers
            if(text.toLowerCase() === 'tic tac toe') { initiateGame('tictactoe'); msgInput.value = ''; return; }
            if(text.toLowerCase() === 'rock paper scissors') { initiateGame('rps'); msgInput.value = ''; return; }

            if(conn && conn.open) {
                conn.send({ type: 'text', content: text });
                addMessage('You', text, 'outgoing');
                msgInput.value = '';
                gameMenu.style.display = 'none';
                conn.send({ type: 'typing', isTyping: false }); // Reset typing
            }
        }

        function addMessage(sender, text, type) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            const nameLabel = type === 'incoming' ? `<span class="sender-name">${sender}</span>` : '';
            div.innerHTML = `${nameLabel}${text}<span class="timestamp">${getTimestamp()}</span>`;
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function addImage(sender, src, type) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            const nameLabel = type === 'incoming' ? `<span class="sender-name">${sender}</span>` : '';
            div.innerHTML = `${nameLabel}<img src="${src}" class="msg-image"><span class="timestamp">${getTimestamp()}</span>`;
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // Image Input
        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const base64 = event.target.result;
                addImage('You', base64, 'outgoing');
                if (conn && conn.open) {
                    conn.send({ type: 'image', content: base64 });
                }
            };
            reader.readAsDataURL(file);
        });

        // --- GAME LOGIC (Unchanged from previous version) ---
        let myTurn = false;
        let mySymbol = 'X'; 
        let tttState = Array(9).fill(null);
        let myRPSMove = null;
        let opponentRPSMove = null;

        function initiateGame(gameName) {
            gameMenu.style.display = 'none';
            msgInput.value = '';
            if(conn && conn.open) {
                myTurn = true;
                mySymbol = 'X'; 
                conn.send({ type: 'game-invite', game: gameName });
                startGameUI(gameName);
            }
        }

        function startGameUI(gameName) {
            document.getElementById('game-overlay').style.display = 'flex';
            document.getElementById('ttt-container').style.display = 'none';
            document.getElementById('rps-container').style.display = 'none';

            if(gameName === 'tictactoe') {
                document.getElementById('game-title').innerText = "Tic Tac Toe";
                document.getElementById('ttt-container').style.display = 'block';
                tttState.fill(null);
                renderTTT();
                if(!myTurn) mySymbol = 'O'; 
                updateStatus(myTurn ? "Your Turn" : `${friendName}'s Turn`);
            } else if (gameName === 'rps') {
                document.getElementById('game-title').innerText = "Rock Paper Scissors";
                document.getElementById('rps-container').style.display = 'block';
                updateStatus("Choose your weapon...");
            }
        }

        function handleGameMove(data) {
            if(data.game === 'tictactoe') {
                tttState[data.index] = data.symbol;
                renderTTT();
                if(!checkWinner(tttState)) {
                    myTurn = true;
                    updateStatus("Your Turn");
                }
            } 
            else if (data.game === 'rps') {
                opponentRPSMove = data.move;
                if(myRPSMove) resolveRPS();
                else updateStatus(`${friendName} has chosen. Pick yours!`);
            }
        }

        function updateStatus(msg) { document.getElementById('game-status').innerText = msg; }
        function closeGame() { document.getElementById('game-overlay').style.display = 'none'; }

        // TTT
        function renderTTT() {
            const board = document.getElementById('ttt-board');
            board.innerHTML = '';
            tttState.forEach((val, idx) => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.innerText = val || '';
                cell.style.color = val === 'X' ? '#ef4444' : '#3b82f6';
                cell.onclick = () => onTTTClick(idx);
                board.appendChild(cell);
            });
        }
        function onTTTClick(idx) {
            if(!myTurn || tttState[idx] || !conn) return;
            tttState[idx] = mySymbol;
            renderTTT();
            myTurn = false;
            updateStatus(`${friendName}'s Turn`);
            conn.send({ type: 'game-move', game: 'tictactoe', index: idx, symbol: mySymbol });
            checkWinner(tttState);
        }
        function checkWinner(board) {
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for(let combo of wins) {
                const [a,b,c] = combo;
                if(board[a] && board[a] === board[b] && board[a] === board[c]) {
                    const winner = board[a] === mySymbol ? "You Win!" : `${friendName} Wins!`;
                    updateStatus(winner);
                    setTimeout(() => alert(winner), 100);
                    return true;
                }
            }
            if(!board.includes(null)) { updateStatus("Draw!"); return true; }
            return false;
        }

        // RPS
        function playRPS(move) {
            if(myRPSMove) return;
            myRPSMove = move;
            updateStatus("Waiting for opponent...");
            conn.send({ type: 'game-move', game: 'rps', move: move });
            if(opponentRPSMove) resolveRPS();
        }
        function resolveRPS() {
            let result = "";
            if(myRPSMove === opponentRPSMove) result = "It's a Draw!";
            else if(
                (myRPSMove === 'rock' && opponentRPSMove === 'scissors') ||
                (myRPSMove === 'paper' && opponentRPSMove === 'rock') ||
                (myRPSMove === 'scissors' && opponentRPSMove === 'paper')
            ) { result = "You Win!"; } else { result = `${friendName} Wins!`; }
            updateStatus(result);
            setTimeout(() => { myRPSMove = null; opponentRPSMove = null; updateStatus("Play again?"); }, 3000);
        }
    </script>
</body>
</html>